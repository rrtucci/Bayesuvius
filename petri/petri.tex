\chapter{Petri Nets COMING SOON}
\label{petri}




\newcommand{\petriar}[3]{{\ar@{.>}@/_1pc/[#1]|*++[o][F-]{#2}
\ar[#1]
\ar@{<.}@/^1pc/[#1]|*++[o][F-]{#3}
}}

% downstream red
\newcommand{\petriarDR}[3]{\ar@[red]@{->}@/_1pc/[#1]|*++[o][F-]{#2}
\ar[#1]
\ar@{<.}@/^1pc/[#1]|*++[o][F-]{#3}
}

% upstream red
\newcommand{\petriarUR}[3]{\ar@{.>}@/_1pc/[#1]|*++[o][F-]{#2}
\ar[#1]
\ar@[red]@{<-}@/^1pc/[#1]|*++[o][F-]{#3}
}
This chapter
is based on Refs.


\section{Conventional Petri Nets}
\subsection{Simple Example of Petri Net}

\beq
\xymatrix{
&&*++[o][F-]{0}\ar[rd]
\\
*++[o][F-]{3}\ar[r]_<<<{\rvp_1}
&\rvx_1\ar[ur]_>{\rvp_2}
\ar[dr]
&&\rvx_2\ar[r]_>>{\rvp_4}
\ar@/_2pc/[lll]
&*++[o][F-]{1}
\\
&&*++[o][F-]{2}\ar[ur]_<{\rvp_3}
}
\eeq

\beq
\xymatrix{
&&*++[F-]{\phantom{0}}\ar[rd]
\\
*++[F-]{\bullet\bullet\bullet}\ar[r]_<<<{\rvp_1}
&\rvx_1\ar[ur]_>{\rvp_2}
\ar[dr]
&&\rvx_2\ar[r]_>>{\rvp_4}
\ar@/_2pc/[lll]
&*++[F-]{\bullet}
\\
&&*++[F-]{\bullet\bullet}\ar[ur]_<<{\rvp_3}
}
\eeq

\beq
W^{\rvx\larrow}=
\begin{array}{c|cc}
&\rvx_1&\rvx_2
\\ \hline
\rvp_1&1&0
\\
\rvp_2&0&1
\\
\rvp_3&0&1
\\
\rvp_4&0&0
\end{array}
,\;
W^{\rvx\rarrow}=
\begin{array}{c|cc}
&\rvx_1&\rvx_2
\\ \hline
\rvp_1&0&1
\\
\rvp_2&1&0
\\
\rvp_3&1&0
\\
\rvp_4&0&1
\end{array}
,\;
W=
W^{\rvx\rarrow}
-W^{\rvx\larrow}=
\begin{array}{c|cc}
&\rvx_1&\rvx_2
\\ \hline
\rvp_1&-1&1
\\
\rvp_2&1&-1
\\
\rvp_3&1&-1
\\
\rvp_4&0&1
\end{array}
\eeq

If

\beq
p=\left[
\begin{array}{c}
p_1
\\
p_2
\\
p_3
\\
p_4
\end{array}
\right]
,\;
x=
\left[
\begin{array}{c}
x_1
\\
x_2
\end{array}
\right]
\eeq

\beq
p(t) =
p(0) + Wx
=
\left[
\begin{array}{c}
p_1(0)-x_1+x_2
\\
p_2(0) + x_1 -x_2
\\
p_3(0)+ x_1-x_2
\\
p_4(0) + x_2
\end{array}
\right]
\eeq

\beq
\xymatrix{
*++[o][F-]{\rvp_2}\ar[dr]
&&*++[o][F-]{\rvp_3}\ar[dl]
\\
&{\rvx_2}\ar[ld]\ar[rd]
\\
*++[o][F-]{\rvp_1}
&&*++[o][F-]{\rvp_4}
}
\eeq

\beq
\begin{array}{c|cccc}
&\rvp_1&\rvp_2&\rvp_3&\rvp_4
\\
\hline
\rvx_2&1&-1&-1&1
\end{array}
\eeq

\subsection{Precise Definition of Petri Net}
Let

$\ZZ_{>0}= \{1, 2, 3, \dots\}$ natural numbers.

$\ZZ_{\geq 0}= \{0, 1, 2, 3, \dots\}$ natural numbers and zero.

\hrule
$\rvp_i =$ ith {\bf place  (a.k.a. buffer, token holder) node}. This node holds either
an integer $\geq 0$ or that number of tokens (tokens are represenxed by bullet points).

$\calp = \{\rvp_i\}_{i=1}^{np}$, set of all places


Let $\ket{\rvp_i}\in \ZZ^{np\times 1}$ be the one-hot 
column vector with
$1$ at position $i$. This will be our {markings or places basis}

\hrule 

$\rvx_i =$ ith {\bf transition node}



$\calx = \{\rvx_i\}_{i=1}{nx}$, set of all transitions

Let $\ket{\rvx_j}\in \ZZ^{nx\times 1}$ be the one-hot 
column vector with
$1$ at position $j$. This will be our {transitions basis}.

\hrule

$\rvx\rarrow \rvy$ denotes an {\bf arrow (a.k.a. directed arc)}. Note that there are two type of arrows:
those that go from an transition to a place node and those which go from a place to
a transition node. Let $\rvx\rarrow\rvy=\rvy\larrow \rvx = (\rvx,\rvy)$

$\cala =$  the set of all arrows. $\cala \subset \ol {\cala} = (\calp \times \calx) \cup (\calx \times \calp) = \{\calp\rarrow\calx or \calx \rarrow \calp:
\rvp\in\calp, \rvx \in \calx\}$.


A {\bf flow} is a directed path of arrows from $\cala$.

\hrule
$\mu : \calp \rarrow \ZZ_{\geq 0}=$ {\bf markings (i.e., contents) of of each place}. Sometimes, it is convenient to consider a fractional number tokens in a place, so
$\mu : \calp \rarrow \RR_{\geq 0}$.



$\kappa : \cala\rarrow \ZZ_{>0}=$ {\bf capacity of each arrow}. If unstated, assume $\kappa(a) = 1$.
for all $a\in\cala$. It's also possible to extend the domain of 
$\kappa()$ to $\ol{\cala}$ and define $\kappa(a) = 0$
for all $a\in \ol{\cala}-\cala$. Sometimes, it is convenient to consider a fractional arrow capacity, so
$\kappa : \cala \rarrow \RR_{\geq 0}$.

\hrule
$W^{\rvx \larrow} \in \bool^{np\times nx}$. 
$W^{\rvx \larrow}_{i,j} = 1$ if there is an arrow $\rvp_i\rarrow\rvx_j$
(entering $\rvx_j$);
else $W^{\rvx \larrow}_{i,j} = 0$. More generally, in the case a capacity function $\kappa()$ is given, let

\beq
W^{\rvx \larrow}_{i,j} = \kappa(\rvp_i\rarrow \rvx_j)
\eeq
In Dirac notation, 

\beq
W^{\rvx \larrow} = \sum_{i,j}\kappa(\rvp_i\rarrow \rvx_j)
\ket{\rvp_i}\bra{\rvx_j}
\eeq


$W^{\rvx \rarrow} \in \bool^{np\times nx}$. 
$W^{\rvx \rarrow}_{i,j} = 1$ if there is an arrow $\rvp_i\larrow\rvx_j$
(leaving $\rvx_j$);
else $W^{\rvx \rarrow}_{i,j} = 0$. More generally, in the case a capacity function $\kappa()$ is given, let

\beq
W^{\rvx \rarrow}_{i,j} = \kappa(\rvp_i\larrow \rvx_j)
\eeq
In Dirac notation, 

\beq
W^{\rvx \rarrow} = \sum_{i,j}\kappa(\rvp_i\larrow \rvx_j)
\ket{\rvp_i}\bra{\rvx_j}
\eeq

$W =W^{\rvx \rarrow}-W^{\rvx \rarrow}\in \{-1, 0, 1\}^{np\times nx}$ This is called the {\bf incidence matrix}.
More generally, if a capacity function is given, 

\beq
W_{i,j} =
 W^{\rvx \rarrow}_{i,j}-W^{\rvx \larrow}_{i,j}=
\kappa(\rvp_i\larrow \rvx_j)
-
\kappa(\rvp_i\rarrow \rvx_j)
\eeq
In Dirac notation, 

\beq
W =  \sum_{i,j}\left[
\kappa(\rvp_i\larrow \rvx_j)
-
\kappa(\rvp_i\rarrow \rvx_j)
\right]
\ket{\rvp_i}\bra{\rvx_j}
\eeq

\hrule
$\calp(\rvx\larrow) = \{\rvp : \rvp \rarrow \rvx\in\cala\}=$ {\bf $\rvx$ input places (a.k.a. $\rvx$ pre-set)}

$\calp(\rvx\rarrow) = \{\rvp : \rvx \rarrow \rvp \in \cala\}=$ {\bf $\rvx$ output places (a.k.a. $\rvx$ post-set)}

$\calx(\rvp\larrow) = \{\rvx : \rvx \rarrow \rvp \in \cala \}=$ {\bf$\rvp$ input transitions (a.k.a. $\rvp$ preset)}

$\calx(\rvp\rarrow) = \{\rvx : \rvp \rarrow\rvx \in\cala\}=$ {\bf $\rvx$ output transitions (a.k.a. $\rvp$ post-set)}

\hrule
$\ket{b(0)}_\calp\in \ZZ_{\geq 0}^{np\times 1} =$ {\bf initial markings}

$\Phi = \av{\calp, \calx, W,\ket{b(0)}_\calp}$ is a {\bf Petri net}.
\subsection{Execution of a Petri net}
Consider a Petri Net $\Phi = \av{\calp, \calx, W,\ket{b(0)}_\calp}$.

By (conventionsal) {\bf firing step} of a transition $\rvx$, we mean the action of removing $\mu(\rvp\rarrow \rvx)$
tokens from all $\rvp\in\calp(\rvx\larrow)$, and adding $\mu(\rvx\rarrow\rvp')$ tokens to all $\rvp'\in\calp(\rvx\rarrow)$.

A transition $\rvx$ is {\bf enabled} 
(i.e., it may fire)
for $\rvp\in \rvx^{\larrow}$, if there are enough tokens in 
$\rvp$ for a firing to be possible; i.e., if $M(\rvp) \geq \mu(\rvp\rarrow \rvx)$. A transition $\rvx$ is {\bf fully enabled} if it is enabled for all $\rvp\in \calp(\rvx\larrow)$.

$t \in \ZZ_{>0}$ is the firing time.

$b_j(t) =$ {\bf markings of place $\rvp_j$} at firing time t.

\beq
\ket{b(t)}_\calp =\sum_j b_j(t) \ket{\rvp_j}
\eeq

$a_i(t) =$ how many times each transition $\rvx_i$
occurs at time t
(i.e., the {\bf strength of transition $\rvx_i$}
at time $t$).

\beq
\ket{a(t)}_\calx =\sum_i a_i(t) \ket{\rvx_i}
\eeq

Note that we use subscripts $\calp$ and $\calx$ to
indicate which basis, either the $\{\ket{\rvp_i}\}_{i=1}^{np}$
or  $\{\ket{\rvx_i}\}_{i=1}^{nx}$
we are referring to.

{\bf Conventional firing rule}\footnote{Many others firing rules are possible}.

\beq
b_j(t+1) = b_j(t)
+\sum_i W_{j,i}(t) a_i(t)
\eeq
where $W_{j,i}(t)=0$ if 
transition $\rvx_i$ 
is not fully enabled.
 
\beq
\ket{b(t+1)}_\calp =
\ket{b(t)}_\calp +
W\ket{a(t)}_\calx
\label{eq-firing-stepper}
\eeq
 
 In general, can replace $W\ket{a(t)}_\calx$ by
 any vector 
 $\ket{A(t)}_\calp$ that can depend on
 the place markings $\mu()$
 for all places
 and
 arrow capacities
 $\kappa()$
 for
 all arrows.

$\ket{a(0)}, \ket{a(1)}, \ket{a(2)},
\ldots$ is the {\bf sequence of firing
steps}.
Often we fire a single transition
in each step,
instead of firing a linear combination 
of them. In such a case, the
sequence of firing steps reduces to
$a_{i(0)}, a_{i(1)}, a_{i(2)},
\ldots$


A marking $\ket{b^*}_\calp$ is {\bf reachable} from a marking  $\ket{b}_\calp$ in 
$n = 1, 2, \ldots$  steps if
$\ket{b}_\calp$ can be transformed to $\ket{b^*}_\calp$ by executing $n$ firings. We write 
$\xymatrix{\ket{b}_\calp\ar[r]_\Phi& \ket{b^*}_\calp}$ and say a
marking $\ket{b^*}_\calp$ is reachable from a marking
$\ket{b}_\calp$ if $\ket{b^*}_\calp$ is reachable from 
$\ket{b}_\calp$ in a finite
number of steps.
The {\bf reachability set} of a Petri Net $\Phi$ with 
initial markings $\ket{b(0)}_\calp$ is defined as

\beq
R(\Phi) = \{\ket{b^*}_\calp: 
\xymatrix{\ket{b(0)}_\calp\ar[r]_\Phi& \ket{b^*}_\calp} \}
\eeq



\section{Generalizations}
\subsection{Continuous Petri net}
So far we have considered
discrete time $t\in \ZZ_{\geq 0}$.
If we let the interval $\Delta t=t_{i+1}-t_i$ between
succesive events tend to zero
and if we replace $W$ by 
$W/\Delta t$ in Eq.(\ref{eq-firing-stepper}), we get
a {\bf continuous Petrin net} obeying:

\beq
\frac{db_j(t)}{dt}=
\sum_i W_{j,i}a_i(t)
\eeq


\beq
\frac{d\ket{b(t)}_\calp}{dt}=
W\ket{a(t)}_\calx
\eeq


\begin{figure}[h!]
$$
\xymatrix@C=5pc{
{a_1}
&&{a_4}
\ar[dl]|{W_{i,4}}
\\
{a_2}
&
*+++[o][F-]{\frac{db_i}{dt}}
\ar[lu]|{W_{1, i}}
\ar[ld]|{W_{2,i}}
\ar[l]|{W_{3, i}}
& {a_5}
\ar[l]|{W_{i,5}}
\\
{a_3}
&&
{a_6}
\ar[lu]|{W_{i,6}}
}$$
\caption{The place nodes (but not the transition nodes)
of a continuous Petri net carry a time derivative.}
\label{eq-continuous-pn}
\end{figure}
We extend $W$ to

\beq
\ol{W}=
\begin{array}{c|cc}
&\rvp_j&\rvx_i
\\ \hline
\rvp_j&0&W_{j,i}
\\
\rvx_i &-W_{j,i} &0
\end{array}
\eeq
The extended matrix $\ol{W}$ is now
an anti-symmetric square matrix.

Thus, a continuous Petri Net can be 
viewed as a bunch linear bnets,
one for each place node that carries a
different time derivative. Then
the leg nodes of those
different bnets are united 
if they carry the same transition.
One writes an equation 
for each place node (time derivative),
but not for each transition node.

\footnote{Note that if we set $\ket{b(t)}=\ket{a(t)}=\ket{\psi(t)}$ and $\ol{W} =-iH$,
we get a Schroedinger equation (on a finite, $np$-dimensional, space):

$$ \frac{d\ket{\psi(t)}}{dt} =-i H \ket{\psi(t)}$$}


\subsection{Colored Petri Nets}
In a conventional Petri net, the tokens
are all of the same kind,
so the marking (i.e., content)
of every place node is given by a scalar
from either $\ZZ_{\geq 0}$
or $\RR_{\geq 0}$.
But if one considers
tokens of various kinds,
then one needs a vector to
store their numbers in each place node.
In the conventional case,
the messages that flow through the arrows
are scalars too, 
but in the multicolored case,
they become matrices or even tensors.
In fact,  one can generalize conventional Petri nets
so that the messages are objects of 
a class.\footnote{The objects
or instances 
of a class are defined in OOP (Object Oriented Programing).}


\subsection{Stochastic Petri Nets}
\subsection{Bayes-Petri Net}
Fire nodes in topological order
{\bf Petrifying a Bnet}

\beq
\xymatrix@C=5pc{
\rvx
\ar[r]
&\rvy
}
\;\;\;\;\;\;
\implies
\;\;\;\;\;\;
\xymatrix@C=5pc{
\rvx
\petriar{r}{2}{3}
&\rvy
}
\eeq


We will refer to the place between $\rvx$ and $\rvy$ with arrow $\rvx\rarrow \rvy$ as $\rvp_{x\rarrow y}$.

{\bf Petri-Bayes Net}

\beq
\begin{array}{ccc}
\xymatrix@R=5pc@C=5pc{
&\rva\ar[dl]\ar[dr]
\\
\rvb\ar[rr]\ar[dr]
&&\rvc\ar[dl]
\\
&\rvd
}
&\xymatrix@R=5pc{
\\
&\implies&}
&
\xymatrix@R=5pc@C=5pc{
&\rva\petriar{dl}{1}{}
\petriar{dr}{}{5}
\\
\rvb\petriar{rr}{}{2}
\petriar{dr}{5}{}
&&\rvc\petriar{dl}{3}{}
\\
&\rvd
}
\end{array}
\eeq



\beq
\xymatrix@R=5pc@C=5pc{
\rva\petriarDR{dr}{}{1}
&&\rvb\petriar{dl}{2}{}
\\
&\rvx
\petriarDR{dr}{4}{}
\petriarDR{dl}{1}{}
\\
\rvc
&&\rvd
}
\;\;\;
\xymatrix@R=5pc@C=5pc{
\rva\petriarDR{dr}{}{1}
&&\rvb\petriarUR{dl}{2}{}
\\
&*++[o][F*:yellow]{\rvx}
\petriar{dr}{4}{}
\petriar{dl}{1}{}
\\
\rvc
&
&\rvd
}
\eeq

\beq
\xymatrix@R=5pc@C=5pc{
\rva\petriarDR{dr}{}{1}
&&\rvb\petriarUR{dl}{2}{}
\\
&{\rvx}
\ar[d]
\petriar{dr}{4}{}
\petriar{dl}{1}{}
\\
\rvc
&
*++[o][F*:yellow]{\rve}
&\rvd
}
\eeq

\beq
\xymatrix@R=5pc@C=5pc{
\rva\petriarUR{dr}{}{1}
&&\rvb\petriarUR{dl}{2}{}
\\
&{\rvx}
\petriarDR{dr}{4}{}
\petriarUR{dl}{1}{}
\\
\rvc
&&\rvd
}
\;\;\;
\xymatrix@R=5pc@C=5pc{
\rva\petriar{dr}{}{1}
&&\rvb\petriar{dl}{2}{}
\\
&*++[o][F*:yellow]{\rvx}
\petriar{dr}{4}{}
\petriarUR{dl}{1}{}
\\
\rvc
&
&\rvd
}
\eeq