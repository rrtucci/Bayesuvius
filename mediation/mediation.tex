\chapter{Mediation Analysis}
\label{ch-mediation}
This chapter is mostly based on 
Refs.\cite{pearl-2019review,
pearl2012-mediation} by Pearl.

To fully
understand this chapter,
the reader should first read Chapter \ref{ch-counterf}
where do and imagine operators are defined.


\begin{figure}[h!]
$$
\begin{array}{ccc}
\\
\xymatrix{
\rvu_\rvd\ar[dd]
&\rvu_\rvm\ar[d]
&\rvu_\rvy\ar[dd]
\\
&\rvm\ar[rd]
\\
\rvd\ar[ru]\ar[rr]&&\rvy
}
&\;\;\;\;&
\xymatrix{
\rvu_\rvd\ar[dd]\ar@/^2pc/@{<-->}[r]
&\rvu_\rvm\ar[d]\ar@/^2pc/@{<-->}[r]
&\rvu_\rvy\ar[dd]
\\
&\rvm\ar[rd]
\\
\rvd\ar[ru]\ar[rr]&&\rvy
}
\\
\\
G_0&&G
\end{array}
$$
\caption{DEN bnets $G_0$ and $G$
are used to 
discuss mediation analysis.
In graph
$G_0$,
the external
variables are independent,
whereas in graph $G$
they are not.}
\label{fig-mediation-bnets}
\end{figure}

\begin{figure}[h!]
$$
\begin{array}{c}
\xymatrix{
&\rvu
\ar@{-->}[d]
\ar@{-->}[ldd]
\ar@{-->}[rdd]
\\
&\rvm\ar[rd]
\\
\rvd\ar[ru]\ar[rr]&&\rvy
}
\\
\\
G_{gen}
\end{array}
$$
\caption{General bnet used to 
discuss mediation analysis.
Node $\rvu$ is a hidden confounder.}
\label{fig-gen-bnet-mediation}
\end{figure}

The term \qt{mediation analysis} (MA)
refers
to  the analysis by Pearl
of the DEN bnet
$G$
in Fig.\ref{fig-mediation-bnets}.
We will discuss MA in terms
of DEN bnets, just as Pearl does.
However, note that much of 
what we will say applies also to 
the general (i.e., not
necessarily a DEN) bnet $G_{gen}$
show in Fig. \ref{fig-gen-bnet-mediation}.



In the DEN bnet $G$,
node $\rvd$ 
influences node
$\rvy$
both
directly
and via the mediator node $\rvm$.
The structural 
equations for $G$
are of the form:

\begin{subequations}
\label{eq-struc-eqs-med}
\beqa
\rvd&=&\rvu_\rvd
\\
\rvm&=&f_\rvm(\rvd, \rvu_\rvm)
\\
\rvy&=&f_\rvy(\rvd, \rvm, \rvu_\rvy)
\;.
\eeqa
\end{subequations}
Thus,

\beq
\rvy=f_\rvy(u_\rvd, 
f_\rvm(\rvu_\rvd, \rvu_\rvm), \rvu_\rvy)
\;.
\eeq

\begin{figure}[h!]
$$
\begin{array}{cccc}
\\
\xymatrix{
\rvu_\rvd\ar@/^2pc/@{<-->}[r]
&\rvu_\rvm\ar[d]\ar@/^2pc/@{<-->}[r]
&\rvu_\rvy\ar[dd]
\\
&\rvm\ar[rd]
\\
\cald\rvd=5\ar[ru]
\ar[rr]&&\rvy
}
&\;\;\;\;\;&
\xymatrix{
\rvu_\rvd\ar[dd]\ar@/^2pc/@{<-->}[rr]
&&\rvu_\rvm\ar[d]\ar@/^2pc/@{<-->}[r]
&\rvu_\rvy\ar[dd]
\\
&\cali_\rvm\rvd=5\ar[r]
&\rvm\ar[rd]
\\
\rvd
\ar[rrr]
&&&\rvy
}
\\
\\
\cald_{\rvd=5}G
&&
\cali_{\rvd\rarrow\rvm}(5)G
\end{array}
$$
\caption{Graph $G$
of Fig.\ref{fig-mediation-bnets}
after applying do operator $\cald_{\rvd=5}$
and imagine operator 
$\cali_{\rvd\rarrow\rvm}(5)$.}
\label{fig-mediation-ops-egs}
\end{figure}

If we apply
$\cald_{\rvd=5}G$
to Eqs.(\ref{eq-struc-eqs-med}), we get

\begin{subequations}
\label{eq-mediation-rho-egs}
\beqa
\rvd&=&5
\\
\rvm&=&f_\rvm(\rvd, \rvu_\rvm)
\\
\rvy&=&f_\rvy(\rvd, \rvm, \rvu_\rvy)
\;.
\eeqa
\end{subequations}
Eqs.\ref{eq-mediation-rho-egs}
are represented graphically
in Fig.\ref{fig-mediation-ops-egs}.
We will often denote the  random variable
 $\rvy$ in Eqs.(\ref{eq-mediation-rho-egs})
by the more explicit symbol 
$\rvy_{\cald_{\rvd=5}G}$.
Pearl often 
refers to
this $\rvy$ by the less explicit symbol
$Y_5$ or $Y_5(u)$ where 
$u=(u_\rvm, u_\rvy)=u_{!\rvd}$.

If we apply
$\cali_{\rvd\rarrow\rvm}(5)G$
to Eqs.(\ref{eq-struc-eqs-med}), we get

\begin{subequations}
\label{eq-mediation-kappa-egs}
\beqa
\rvd&=&\rvu_\rvd
\\
\rvm&=&f_\rvm(5, \rvu_\rvm)
\\
\rvy&=&f_\rvy(\rvd, \rvm, \rvu_\rvy)
\;.
\eeqa
\end{subequations}
Eqs.\ref{eq-mediation-kappa-egs}
are represented graphically
in Fig.\ref{fig-mediation-ops-egs}.
We will often denote the  random variable
 $\rvy$ in Eqs.(\ref{eq-mediation-kappa-egs})
by the more explicit symbol 
$\rvy_{\cali_{\rvd\rarrow\rvm}(5)G}$.
 Pearl often 
refers to
this $\rvy$ by the less explicit symbol
$Y_5$ or $Y_5(u)$ where
$u=(u_\rvd, u_\rvm, u_\rvy)$.

\hrule

\begin{figure}[h!]
$$
\begin{array}{cccc}
\\
\xymatrix{
\rvu_\rvd\ar@/^2pc/@{<-->}[r]
&\rvu_\rvm\ar[d]\ar@/^2pc/@{<-->}[r]
&\rvu_\rvy\ar[dd]
\\
&\rvm\ar[rd]
\\
\cald\rvd=d\ar[ru]
\ar[rr]&&\rvy
}
&\;\;\;\;
&
\xymatrix{
\rvu_\rvd\ar@/^2pc/@{<-->}[r]
&\rvu_\rvm\ar@/^2pc/@{<-->}[r]
&\rvu_\rvy\ar[dd]
\\
&\cald\rvm=m\ar[rd]
\\
\cald\rvd=d
\ar[rr]&&\rvy
}
\\
\\
\cald_{\rvd=d}G
&&
\cald_{\rvd=d}\cald_{\rvm=m}G
\end{array}
$$
\caption{Graph $G$
of Fig.\ref{fig-mediation-bnets}
after applying the 
do operators $\cald_{\rvd=d}$
and
$\cald_{\rvd=d}\cald_{\rvm=m}$.}
\label{fig-mediation-rho}
\end{figure}

Define

\beq
\caly_d=E[\rvy_{\cald_{\rvd=d}G}]
=
\sum_y
y P(y|\cald\rvd=d)
\eeq
and

\beq
\caly_d^{m}=
 E[
\rvy_{\cald_{\rvd=d}
\cald_{\rvm=m}
G}
]=
\sum_y
y P(y|\cald\rvd=d, \cald\rvm=m)
\eeq
The two DEN diagrams
$\cald_{\rvd=d}G$
and
$\cald_{\rvd=d}\cald_{\rvm=m}G$
used in the definitions
of $\caly_d$ and $\caly^m_d$
are given in Fig.\ref{fig-mediation-rho}.

Now define the Total Effect (TE),
and the
Controlled Direct Effect (CDE) by
\beqa
TE&=& \caly_1-\caly_0
\\
CDE(m)&=&
\caly_1^m-\caly_0^m
\eeqa

\hrule

\begin{figure}[h!]
$$
\begin{array}{c}
\\
\xymatrix{
\rvu_\rvd\ar@/^2pc/@{<-->}[rr]
&&\rvu_\rvm\ar[d]\ar@/^2pc/@{<-->}[r]
&\rvu_\rvy\ar[dd]
\\
&\cali_\rvm\rvd=d'\ar[r]
&\rvm\ar[rd]
\\
\cald \rvd=d\ar[rrr]
&
&&\rvy
}
\\
\\
\cald_{\rvd=d}
\cali_{\rvd\rarrow\rvm}(d')
G
\end{array}
$$
\caption{
Graph $G$
of Fig.\ref{fig-mediation-bnets}
after
applying the 
imagine operator
 $\cali$
 to arrow
$\rvd\rarrow\rvm$ and 
the do operator to node $\rvd$.}
\label{fig-mediation-kappa}
\end{figure}

Define

\beq
\calypso_d^{d'}=
 E[
\rvy_{\cald_{\rvd=d}
\cali_{\rvd\rarrow\rvm}(d')
G}
]=\sum_y y P(y|\cald\rvd=d, \cali_\rvm\rvd=d')
\eeq
Fig.\ref{fig-mediation-kappa}
shows the diagram 
$
\cald_{\rvd=d}\cali_{\rvd\rarrow\rvy}(d')G$
used in
the definition of $\calypso_d^{d'}$.

Note that

\beq
\calypso_d^{d'}
=\sum_m\caly_d^m P(\rvm=m|d')
\eeq
if there is no arrow 
$\rvu_\rvm\rarrow \rvm$.
This expresses
$P(y|\cald\rvd=d, \cali\rvd=d')$
in terms of $P(y|\cald\rvd=d, \cald\rvm=m)$.

Define
\beq
\calypso_d^{d'-}=\calypso_d^{d'}-\calypso_{d'}^{d'}
\eeq
and
\beq
\calypso_{d-}^{d'}=\calypso_d^{d'}-\calypso_{d}^{d}
\eeq

Now define the
Natural Direct Effect (NDE), and the
Natural Indirect Effect (NIE)
by
\beqa
NDE_{d}^{d'}
&=&\calypso_{d}^{d'-}
\\
NIE_{d}^{d'}
&=&\calypso_{d-}^{d'}
\;.
\eeqa

Note that
\beqa
NDE_1^0-NIE_1^0&=&
-\calypso_0^0+\calypso_1^1
\\
&=&
TE
\;.
\eeqa

{\bf Linear Case}

Consider 
the LDEN
of Fig.\ref{fig-mediation-linear}.
One has

\begin{figure}[h!]
$$
\xymatrix{
\rvu_\rvd\ar[dd]
&\rvu_\rvm\ar[d]
&\rvu_\rvy\ar[dd]
\\
&\rvm\ar[rd]_\beta
\\
\rvd\ar[ru]_\alp\ar[rr]_\gamma
&&\rvy
}$$
\caption{LDEN 
that is used to discuss mediation analysis.}
\label{fig-mediation-linear}
\end{figure}

\begin{subequations}
\beqa
\rvd&=&\rvu_\rvd
\\
\rvm&=&\alp\rvd +\rvu_\rvm
\\
\rvy&=&\gamma\rvd +\beta\rvm +\rvu_y
\;.
\eeqa
\end{subequations}

\beq
\caly_d=(\gamma + \alp\beta)d
\eeq

\beq
\caly_d^m=
\gamma d +\beta m
\eeq

\beq
\calypso_d^{d'}=\gamma d + \alp\beta d'
\eeq

\beq
TE=\caly_1-\caly_0=\gamma +\alp\beta
\eeq

\beq
CDE(m)=\caly^m_1-\caly^m_0=\gamma
\eeq

\beq
NDE_1^0=\calypso_1^{0-}=\gamma
\eeq

\beq
NIE_1^0=\calypso_{1-}^0=-\alp\beta
\eeq
As expected, $NDE_1^0-NIE_1^0=TE$.

$TE$ and the \qt{controlled effect}
$CDE(m)$
contain do operators
but no imagine 
operators 
so one can do 
do-intervention 
experiments to
calculate them.
On the other hand,
the \qt{natural effects} $NDE_1^0$ and $NIE_1^0$
contain
imagine 
operators
(and therefore
counterfactual
distributions)
so it's not
obvious how to 
calculate them,
or even whether it
is possible to do so.
The next claim
shows how to calculate
$\calypso_d^{d'}$ 
in certain
cases. 
In technical jargon,
the claim 
gives sufficient conditions
for $\cald\cali$-identifiability
of $\calypso_d^{d'}$.
$NDE_1^0$ and $NIE_1^0$
can be calculated once
$\calypso_d^{d'}$ is known.


\begin{claim}\label{cl-med-simple}
\decMediationSimple
\end{claim}
\proof See Claim \ref{cl-decMediationSimple}.
\qed

\begin{claim}\label{cl-med-plus}
\decMediationPlus
\end{claim}
\proof See Claim \ref{cl-decMediationPlus}.
\qed

Actually,

\beq
\sum_m
P(y|d,m)P(m|d')=
\sum_\xi \sum_m
P(y|d,m, \xi)P(m|d', \xi)P(\xi)
\eeq
so the adjustment
formulae in
Claims \ref{cl-med-simple}
and \ref{cl-med-plus}
 are equivalent,
but if the available dataset 
contains info about
$\xi$,
then the adjustment formula
that uses that $\xi$ info should be used,
as it will be more
sensitive to deviations
from the DAG model being hypothesized.

%\input{mediation/mediation-limbo.tex}
