\chapter{Message Passing, Bethe's theory
(COMING SOON)}
\label{ch-mpass-bethe}

Define the {\bf partition function} $Z_\theta$ by
\beq
Z_\theta = \sum_x   e^{-\theta^T \calu(x)}
\eeq



\beqa
\underbrace{P(x|\theta)
}_{e^{-\cals_\theta(x)}} &=& 
\exp( -\theta^T \calu (x) - \ln Z_\theta)
\label{eq-px-at-theta}
\\
&=&
\frac{
e^{-\theta^T \calu(x)}}{Z}
\eeqa
$\calu(x)$ is called {\bf sufficient
statistic (SS)} for $\rvx$ because
$P(x|\theta)$
is a functional (i.e.,
a function of a function) of $\calu(x)$.

\beqa
-\partial_{\theta_i} \ln Z_\theta
&=&
\frac{1}{Z_\theta}
\sum_x   
\calu_i(x)
e^{-\theta^T \calu(x)}
\\
&=&
E_{\rvx|\theta}[\calu_i(\rvx)]=\av{\calu_i}
\eeqa


\begin{align}
\partial_{\theta_j}
\partial_{\theta_i} \ln Z_\theta
&=
\partial_{\theta_j}\frac{1}{Z_\theta}
\sum_x   
-\calu_i(x)
e^{-\theta^T \calu(x)}
\\
&=
\left\{
\begin{array}{l}
\frac{1}{Z_\theta}
\sum_x   
\calu_j(x)\calu_i(x)
e^{-\theta^T \calu(x)}
\\
+\frac{-1}{Z_\theta^2}
\left[
\sum_x   
-\calu_j(x)
e^{-\theta^T \calu(x)}
\right]
\left[
\sum_x   
-\calu_i(x)
e^{-\theta^T \calu(x)}
\right]
\end{array}
\right.
\\
&=
\av{\calu_j\calu_i}
-\av{\calu_j}\av{\calu_i}
\\
&=
\av{\calu_j, \calu_i}
\end{align}




\beq
-\cals_\theta(x)= -\theta^T \calu(x) 
-\ln Z_\theta
\eeq
Define the {\bf entropy} $S$ by
\footnote{In Thermodynamics,
the entropy is denoted by the letter
$S$. In Shannon Information
Theory, and elsewhere in this
book, it is denoted by the letter $H$.}

\beqa
S &=& \sum_x
 P(x|\theta)\cals_\theta(x)
 \\
 &=&
 -\sum_x P(x|\theta)\ln P(x|\theta)
\eeqa
Define the {\bf internal energy} $U$ by 
\beq
U = \sum_x P(x|\theta)\calu_\theta(x)
\eeq

\beq
-S=-\theta^T U - \ln Z_\theta
\eeq

\beq
\partial_{U_i} S= \theta_i
\eeq
$S$ is concave.
$S$ and $-\ln Z_\theta=F/T$
are concave dual functions.\footnote{
Concave dual functions
are discussed in Chapter \ref{ch-var-bay-medical}}.

\begin{mdframed}[hidealllines=true,backgroundcolor=gray!10]
{\bf Relationship to Thermodynamics}

In Thermodynamics,
$U$ is the internal energy
and $S$ is the entropy
of a system
at {\bf temperature} $T$.
Define $\theta\in\RR$ to be
the inverse temperature 
\beq
\theta = \frac{1}{T}
\eeq
Define the {\bf free energy} $F$ by
\beqa
F&=& -T \ln Z_\theta
\\
&=&
-T\ln 
\sum_x e^{-\frac{\calu(x)}{T}}
\eeqa
Then

\beq
U-TS = F
\eeq
So the free energy equals
the internal energy minus
the energy held in disordered form.
\end{mdframed}

\newcommand{\ttheta}[0]{\TIL{\theta}}
\newcommand{\tP}[0]{\TIL{P}}

\beqa
0&\leq& D_{KL}(P(x|\ttheta)
\parallel P(x|\theta))
\\
&=&
\sum_x P(x|\ttheta)\ln
\frac{P(x|\ttheta)}
{P(x|\theta)}
\\
&=&
-\TIL{S}
-\sum_x P(x|\ttheta)
\left[
-(\theta)^T\calu(x)-\ln Z_{\theta}
\right]
\\
&=&
-\TIL{S}
+(\theta)^T\TIL{U} + \ln Z_{\theta}
\quad\text{($\TIL{S}, \TIL{U}$ correspond to parameter $\ttheta$)}
\eeqa


\beq
\TIL{S} = \min_{\theta}\left[
(\theta)^T\TIL{U} + \ln Z_{\theta}\right]
\eeq

\beq
-\ln Z_{\theta}=
\min_{\TIL{U}}\left[
(\theta)^T\TIL{U} -\TIL{S}
\right]
\label{eq-max-u-tilde}
\eeq

\beq
\TIL{P}(x)=P(x|\TIL{\theta})
\eeq

Mean Field approximation
\beq
\TIL{P}^{ind}(x)=
\prod_
k
\TIL{P}(x_k)
\eeq




\beqa
\TIL{S}^{ind}
&=&
-\sum_x\tP(x)\ln \prod_i \tP(x_i)
\\
&=&
-\sum_{x_i} \tP(x_i)\ln \tP(x_i)
\\
&=&
\sum_i \TIL{H}(\rvx_i)
\eeqa

\beq
\TIL{P}^{tree}(x)=
\TIL{P}^{ind}(x)
\prod_
{i-j}
\frac{
\TIL{P} (x_i
, x_j )}{
\TIL{P}(x_i)\TIL{P} (x_j )}
\eeq

\beqa
\TIL{S}^{tree}
&=&
\sum_i\TIL{H}(\rvx_i)
-
\sum_{i-j}\sum_{x_i, x_j}
\tP(x_i,x_j)
\ln \frac{\tP(x_i, x_j)}
{\tP(x_i)\tP(xj)}
\\
&=&
\sum_i \TIL{H}(\rvx_i)
-
\sum_{i-j} \TIL{H}(\rvx_i:\rvx_j)
\eeqa

Note that $\TIL{S}^{tree}$
can be write using the
joint entropy $\TIL{H}(\rvx_i, \rvx_j)$
instead of the mutual entropy
$\TIL{H}(\rvx_i:\rvx_j)$.

\beq
\TIL{S}^{tree}=
-\sum_i(d_i-1)\TIL{H}(\rvx_i)
+ \sum_{i-j}\TIL{H}(\rvx_i, \rvx_j)
\eeq
where $d_i$
is the number of neighbors of node $i$.


Bethe approximation.
$\TIL{S}^{tree}$ is called the {\bf Bethe Entropy}
\beq
\TIL{S}^{tree} - \ln Z_{\theta}\geq
(\theta)^T\TIL{U} \approx 0
\eeq

\beq
-\ln Z_\theta
\gtrapprox \TIL{S}^{tree}
\eeq



\beqa
\cald &=&D_{KL}(P(x|\ttheta)
\parallel P(x|\theta))
\\
&=&
D_{KL}(\tP(x)
\parallel P(x))
\eeqa

Note that ,
in $m_{a\rdart i}(x_i)$,
$i$ (i.e., the arrow target) 
and $x_i$ (i.e., the argument
of the function) 
refer to the same thing and
next to each other.
This is always the case in
our notation for messages.  

\beq
\TIL{P}_{i,j} (x_i
, x_j ) 
=\caln(!x_i, !x_j)
 \Psi_{i,j}(x_i
, x_j )
\prod_{a\in \partial i \setminus j}
m_{a\rdart i}(x_i)
\prod_{b\in \partial j \setminus i}
m_{b\rdart j}(x_j)
\eeq

\beq
P(x)=\caln(!x)\prod_{i-j}\Psi_{i,j}(x_i, x_j)
\eeq

\beq
m_{j\rdart i}^{new}
(x_i) =
\sum_{x_j}
\Psi_{i,j}(x_i, x_j)
\prod_{k\in
\partial j\setminus i}
m_{k\rdart j} (x_j) 
\eeq

If we replace $-\ln Z_\theta$ by
$\TIL{S}^{tree}$ in Eq.(\ref{eq-max-u-tilde}),
we get 

\beq
-S=\max_{\TIL{U}}\left[
-(\theta)^T\TIL{U} +\TIL{S}^{tree}
\right]
\eeq

\beqa
(\theta)^T\TIL{U} &=&
\sum_i \theta_i\sum_x \tP(x)\calu_i(x)
\\
&=&
\sum_x\tP(x)
\underbrace{\sum_i \theta_i \calu_i(x)}
_{\text{ call } \Theta(x)}
\eeqa

the Bethe Variational Problem (BVP).

\beq
\max_{\tP}\left[
-\sum_x \tP(x)\Theta(x)
+ \sum_i\TIL{H}(\rvx_i)
-\sum_{i-j}\TIL{H}(\rvx_i:\rvx_j)
\right]
\eeq
subject to $\sum_x \tP(x)=1$.

\beq
\call=
\left\{
\begin{array}{l}
-\sum_x \tP(x)\Theta(x)
\\
-\sum_i (1-d_i) 
\sum_{x_i}
\tP(x_i)
\ln
\tP(x_i)
\\
-\sum_{i-j}\sum_{x_i, x_j}\tP(x_i, x_j)
\ln P(x_i, x_j)
\\
\sum_x \lam(x)\left[
\tP(x)-1
\right]
\end{array}
\right\}
\eeq


\beqa
\delta\left[f(x_i) \tP(x_i)\right] 
&=&f( x_i)\delta 
\sum_{x\setminus x_i}\tP(x)
\\
&=&
f(x_i)
\sum_{x\setminus x_i}\delta\tP(x)
\\
&=&
\sum_{x'}
\delta\tP(x')
\left[
\delta(x_i', x_i )f(x_i')
\right]
\eeqa
Likewise,
\beq
\delta\left[f(x_i,x_j) \tP(x_i,x_j)\right] 
=
\sum_{x'}
\delta\tP(x')
\left[
\delta(x_i', x_i )
\delta(x_j', x_j )f(x_i', x_j')
\right]
\eeq

\beq
\delta\call=
\sum_{x'}\delta\tP(x')
\left\{
\begin{array}{l}
-\Theta(x')
\\
-\sum_i (1-d_i) 
\left[1+\ln
\tP(x_i')\right]
\\
-\sum_{i-j}
\left[1+
\ln \tP(x_i', x_j')\right]
\\
\lam(x')
\end{array}
\right\}
\eeq

\beq
0=
\left\{
\begin{array}{l}
-\Theta(x')
\\
-\sum_i  
\left[1+\ln
\tP(x_i')\right]
\\
-\sum_{i-j}
\left[1+
\ln \frac{\tP(x_i', x_j')}
{\tP(x_i')\tP(x_j')}
\right]
\\
+\lam(x')
\end{array}
\right\}
\eeq



\beq
m_{t\rdart s}(x_s)=
e^{\lam_{t\rdart s}(x_s)}
\eeq

\beq
\tP(x_i)
=\caln(!x_i)
e^{-\Theta(x_i)}
\prod_{a\in \partial i}
m_{a\rdart i}(x_i)
\eeq

\beq
\tP(x_i, x_j)=
\caln(!(x_i, x_j))
e^{-\Theta(x_i, x_j) 
- \Theta(x_i)
-\Theta(x_j)}
\left[\prod_{a\in \partial i
\setminus j} m_{a\rdart i}(x_i)
\right]
\left[\prod_{b\in \partial j
\setminus i} m_{b\rdart j}(x_j)
\right]
\eeq

\beq
0=
\left\{
\begin{array}{l}
-\Theta(x)
\\
+\sum_i \Theta(x_i)
\\
+\sum_{i-j}\Theta(x_i, x_j)
\end{array}
\right\}
\eeq

\beqa
0&=&
\left\{
\begin{array}{l}
-\sum_i \ln 
\prod_{a\in \partial i}m_{a\rdart i}(x_i)
\\
-\sum_{i-j}\ln 
\frac{\left[\prod_{a\in \partial i
\setminus j} m_{a\rdart i}(x_i)
\right]
\left[\prod_{b\in \partial j
\setminus i} m_{b\rdart j}(x_j)
\right]
}{
\prod_{a\in \partial i}m_{a\rdart i}(x_i)
\prod_{b\in \partial j}m_{b\rdart j}(x_j)
}
\\
+\lam(x)
\end{array}
\right\}
\\
&=&
\left\{
\begin{array}{l}
-\sum_i
\sum_{a\in \partial i} \lam_{a\rdart i}(x_i)
\\
+
\sum_{i-j}\left[
\lam_{j\rdart i}(x_i)+ \lam_{i\rdart j}(x_j)
\right]
\\
+\lam(x)
\end{array}
\right\}
\\
&=&
\lam(x)
\eeqa








