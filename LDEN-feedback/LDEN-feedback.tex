\chapter{LDEN with feedback loops: 
COMING SOON}\label{ch-LDEN-feedback}

This chapter assumes that
the reader has read Chapter 
\ref{ch-linear-sys} on LDEN  (linear
deterministic with external noise) diagrams
and Section \ref{sec-z-transform} on the Z-transform.
The algorithm described in this 
chapter
was first published here, and 
is implemented 
in my software SCuMpy (see Ref.\cite{scumpy}).

\begin{figure}[h!]
$$
\begin{array}{cc}
\xymatrix@R=4pc{
\rvx_0\ar@(ul,ur)@[green]@{-->}[]^{\beta_{0|0}}
\ar@[green]@{-->}@/_3pc/[d]_{\beta_{1|0}}
\ar[d]^{\alp_{1|0}}
\\
\rvx_1\ar@(dl,dr)@[green]@{-->}[]_{\beta_{1|1}}
\ar@[green]@{-->}@/_3pc/[u]_{\beta_{0|1}}
}
&
\xymatrix{
\rvx_0^{[1]}\ar[d]
\ar@[green][r]\ar@[green][rd]
&\rvx_0^{[2]}\ar[d]
\ar@[green][r]\ar@[green][rd]
&\rvx_0^{[3]}\ar[d]
\\
\rvx_1^{[1]}\ar@[green][r]\ar@[green][ru]
&\rvx_1^{[2]}\ar@[green][r]\ar@[green][ru]
&\rvx_1^{[3]}
}
\\
(a)&(b)
\end{array}
$$
\caption{
LDEN diagrams with two $\rvx_j$
nodes
(exogenous nodes $\rvu_j$
not shown). Figure $(a)$ shows a single time-slice
with feedback loops. Figure $(b)$ is an
``unrolled" version of figure $(a)$
showing 3 time-slices.
LDEN diagrams with feedback loops are
a special case of Dynamic Bayesian networks  (DBN) (see Chapter \ref{ch-dyn-bnet})}
\label{fig-LDEN-fb-2nds}
\end{figure}



\beqa
\rvx_0^{[n+1]} &=& \underbrace{\sum_{j=0}^1\beta_{0|j}\rvx_j^{[n]}
 }_{\text{from past}}
 +\rvu_0^{[n+1]}
\\
\rvx_1^{[n+1]} &=&
\underbrace{\sum_{j=0}^1\beta_{1|j}\rvx_j^{[n]}
}_{\text{from past}}
+  \alp_{1|0}\rvx_0^{[n+1]} + \rvu_1^{[n+1]}
\eeqa

for $n=0,1,2, \dots$ with
$
\rvx^{[0]}_j=0$ for all $j$.

From Section \ref{sec-z-transform}

\beq
\calz(\rvx^{[n+1]}_j)
=
z\left(
\TIL{\rvx}_j(z)
-z
\rvx^{[0]}_j
\right)= z\TIL{\rvx}_j(z)
\eeq

\beqa
z\TIL{\rvx}_0(z) &=& \sum_{j=0}^1\beta_{0|j}
\TIL{\rvx}_j(z)
 +z\TIL{\rvu}_0(z)
\\
z\TIL{\rvx}_1(z) &=&
\sum_{j=0}^1\beta_{1|j}\TIL{\rvx}_j(z)
+  \alp_{1|0}z\TIL{\rvx}_0(z) + z\TIL{\rvu}_1(z)
\eeqa
 
\beq
\TIL{x}=\left[
\begin{array}{c}
\TIL{x}_0
\\
\TIL{x}_1
\end{array}
\right],
\quad
\TIL{u}=\left[
\begin{array}{c}
\TIL{u}_0
\\
\TIL{u}_1
\end{array}
\right]
,\quad
A=\left[
\begin{array}{cc}
0
&0
\\
\alp_{1|0}
&0
\end{array}
\right]
,\quad
B=\left[
\begin{array}{cc}
\beta_{0|0}
&\beta_{0|1}
\\
\beta_{1|0}
&\beta_{1|1}
\end{array}
\right]
\eeq

\beq
\indi_A = 1 - A
\eeq

\beq
M(z)= \indi_A -B/z
\eeq

\beq
M(z)\TIL{x}(z) =\TIL{u}(z)
\eeq


\beq
[C_{\TIL{\rva}}^{z_1,z_2}]_{i,j} =\av{\TIL{\rva}_i(z_1), \TIL{\rva}_j(z_2)},
\quad
[C_{\rva}^{[n]}]_{i,j} =\av{\rva_i^{[n]}, \rva_j^{[n]}}
\eeq
for $\rva = \rvx, \rvX, \rvu, \TIL{\rvx},
\TIL{\rvX}, \TIL{\rvu}$



\begin{claim}
\beq
C_\rvx^{[n]}
= G^{n-1}\; C_1 \;(G^T)^{n-1}
\eeq
for $n=1,2,3 \ldots$,
where the ``growth matrix" $G$ is given by

\beq
G=\indi_A^{-1}B
\eeq
and the ``initial covariance matrix" 
$C_1$ by

\beq C_1 =
\indi_A^{-1}
diag(\s^2_{\rvu_i})
 (\indi_A^{-1})^T
\eeq

\end{claim}
\proof

Section \ref{sec-z-transform}
\beq
x_1^{[n]} x_2^{[n]}=
\calz^{-1}\left[
\frac{1}{2\pi i}
\oint_C \frac{dw}{w}\;
\TIL{x}_1(w)
\TIL{x}_2\left(
\frac{z}{w}
\right)
\right]
\eeq

\beq
\underbrace{\calz^{-1}[\TIL{x}(z)]}
_{x^{[n]}}=
\frac{1}{2\pi i}
\oint_C dz\;
\TIL{x}(z)z^{n-1}
\label{eq-z-transform-inverse}
\eeq

\beq
\underbrace{
\av{\rvx^{[n]},\rvx^{[n]T}}
}_{C^{[n]}_\rvx}
=
\calz^{-1}\left[
\frac{1}{2\pi i}
\oint_C \frac{dw}{w}\;
\underbrace{
\av{
\TIL{\rvx}(w),
\TIL{\rvx}^T\left(
\frac{z}{w}
\right)}
}_{C^{w,z/w}_{\TIL{\rvx}}}
\right]
\eeq

\beq
C_{\TIL{\rvx}}^{w, z/w}=
M^{-1}(w)
C_{\TIL{\rvu}}^{w,z/w}
(M^{-1})^T(z/w)
\eeq


\beq
C^{[n]}_\rvx
=
\calz^{-1}
\left[
\frac{1}{2\pi i}
\oint_C \frac{dw}{w}\;
M^{-1}(w)C_{\TIL{\rvu}}^{w,z/w}
(M^{-1})^T(z/w)
\right]
\eeq
For all $i$,
$\rvu_i^{[0]}=0$ because
$\rvx_i^{[0]}=0$.
Keep in mind that $\heavy_0^{[n]}=1$ at $n=0$.



\beq
\av{\rvu_i^{[n]},\rvu_j^{[n]}
} =\delta(i,j)\s^2_{\rvu_i}
\heavy_1^{[n]}
\eeq


Section \ref{sec-z-transform}

\beq\calz\left[
a^n \heavy_0^{[n]}\right]=
\frac{1}{1-a/z}=
\frac{z}{z-a}
\quad \text{for $|z|>|a|$}
\label{eq-z-transform-heavy}
\eeq

\beq
\calz[\delta_{n_0}^{[n]}] = z^{-n_0}
\eeq

\beq
H_0^{[n]}=\sum_{k=0}^\infty\delta^{[n]}_k
\eeq

\beq
\heavy^{[n]}_{1} = 
\heavy^{[n]}_{0} -\delta^{[n]}_0
\eeq

\beqa
\calz[\heavy^{[n]}_{1}]
&=&
\calz[\heavy^{[n]}_{0}]-
\calz[\delta^{[n]}_0]
\\
&=&
\frac{z}{z-1}-1
\\
&=&
\frac{1}{z-1}
\eeqa




\beq
\calz[\av{\rvu_i^{[n]},\rvu_j^{[n]}}]
= \delta(i,j)\s^2_{\rvu_i}\frac{1}{z-1}
\eeq

\beq
\calz[\av{\rvu_i^{[n]}, \rvu_j^{[n]}}]=
\frac{1}{2\pi i}
\oint_C \frac{dw}{w}\;
\av{\TIL{\rvu}_i(w),
\TIL{\rvu}_j\left(
\frac{z}{w}
\right)}
\eeq

\beq
\av{\TIL{\rvu}_i(w),\TIL{\rvu}_j(z/w)}
= \delta(i,j)\s^2_{\rvu_i}\frac{1}{z-1}
\approx
\delta(i,j)\s^2_{\rvu_i}\frac{1}{z}
\eeq

\beq
C^{[n]}_\rvx
=
\calz^{-1}
\left[
\frac{1}{2\pi i}
\oint_C \frac{dw}{w}\;
M^{-1}(w)\frac{diag(\s^2_{\rvu_i})}
{z}
(M^{-1})^T(z/w)
\right]
\eeq

\beqa
M^{-1}(w)&=&(\indi_A - B/w)^{-1}
\\
&=&
(\indi_Aw -B)^{-1}w
\\
&=&
(w-\indi_A^{-1}B)^{-1}w\indi_A^{-1}
\\
&=&
\frac{w}
{w-\indi_A^{-1}B}
\indi_A^{-1}
\eeqa

\beqa
(M^{-1})^T(z/w)&=&
(\indi_A^{-1})^T
\frac{z/w}
{z/w-B^T(\indi_A^{-1})^T}
\\
&=&
(\indi_A^{-1})^T
\frac{z}
{z-B^T(\indi_A^{-1})^Tw}
\eeqa

\beq
x^{[n-1]}=
\calz^{-1}\left[
\frac{1}{z}\TIL{x}(z)\right] 
\label{eq-z-delay}
\eeq

Using Eq.(\ref{eq-z-transform-heavy})
and Eq.(\ref{eq-z-delay}), we get
\beq
\calz^{-1}_z\left[
\frac{1}{z}
(M^{-1})^T(z/w)\right]
=
 (\indi_A^{-1})^T
\left[B^T(\indi_A^{-1})^Tw\right]^{n-1}
\eeq

\begin{align}
C_\rvx^{[n]}
&=
\frac{1}{2\pi i}
\oint_C \frac{dw}{w}\;
M^{-1}(w)
diag(\s^2_{\rvu_i})
\calz^{-1}_z\left[
(M^{-1})^T(z/w)\right]
\\
&=
\left[
\frac{1}{2\pi i}
\oint_C dw\;
\frac{w^{n-1}}
{w-\indi_A^{-1}B}
\right]
\indi_A^{-1}
diag(\s^2_{\rvu_i})
 (\indi_A^{-1})^T
\left[B^T(\indi_A^{-1})^T\right]^{n-1}
\\
&=
\calz_{w}^{-1}
\left[
\frac{1}
{w-\indi_A^{-1}B}
\right]
\indi_A^{-1}
diag(\s^2_{\rvu_i})
 (\indi_A^{-1})^T
\left[B^T(\indi_A^{-1})^T\right]^{n-1}
\quad\text{(by Eq.(\ref{eq-z-transform-inverse}))}
\\
&=
[\indi_A^{-1}B]^{n-1}
\indi_A^{-1}
diag(\s^2_{\rvu_i})
 (\indi_A^{-1})^T
\left[B^T(\indi_A^{-1})^T\right]^{n-1}
\;\text{(by Eqs.(\ref{eq-z-transform-heavy})(\ref{eq-z-delay}))}
\end{align}
\qed

\beq
\rvx^{[n+1]} = B\rvx^{[n]} + A\rvx^{[n+1]}
+ \rvu^{[n+1]}
\eeq

\beq
\av{\rvu^{[n+1]}, \rvx^{[n]T}}=0
\eeq

\beq
(1-A)\av{\rvx^{[n+1]}, \rvx^{[n]T}}=
B \av{\rvx^{[n]}, \rvx^{[n]T}}
\eeq

\beq
\boxed{
\indi_A\av{\rvx^{[n]}, \rvx^{[n+1]T}}^T=
B \av{\rvx^{[n]}, \rvx^{[n]T}}}
\eeq



\beq
\av{\rvx^{[n+1]}, \rvx^{[n+1]T} }
= B
\av{\rvx^{[n]},\rvx^{[n+1]T} } + A\av{\rvx^{[n+1]},\rvx^{[n+1]T} }
+ \av{\rvu^{[n+1]}, \rvx^{[n+1]T} }
\eeq

For any matrix $A$,
define $SL(A)$ 
to be the strictly lower triangular
matrix obtained from matrix $A$ by
setting to zero all entries 
on the main diagonal of $A$ and above it.
Note that

\beq 
SL(\av{\rvu^{[n+1]}, \rvx^{[n+1]T} })=0
\eeq
by causality,
because the nodes are assumed to be topologically ordered (when the feedback
arrows are removed),
and $\rvx^{[n+1]}$ cannot be correlated
with the future noise $\rvu^{[n+1]}$.
Thus,

\beq
\boxed{
SL\left(\av{\rvx^{[n+1]}, \rvx^{[n+1]^T} }
-\underbrace{B
\av{\rvx^{[n]},\rvx^{[n+1]T} }
}_{K}
\right)
= SL\left(A\av{\rvx^{[n+1]},\rvx^{[n+1]^T} }\right)}
\label{eq-sl-a-k}
\eeq
 
 
The same method can be used to solve for
$A$ when $K\neq 0$.

