\chapter{Diffusion Models (COMING SOON)}
\label{ch-diffusion}
\newcommand{\prodalp}[0]{\pi_1^t\alp}

Diffusion Model (DM)

\section{Bnet for DM}

Let
\beq
0< \alp^t\
< 1, \; \beta^t= 1-\alp^t
\eeq

\beq
\prodalp= \prod_{\tau=1}^t \alp^\tau
\eeq

Fig.\ref{fig-diffusion1} shows a
bnet for DM, and  
\ref{fig-diffusion2}
shows the same bnet 
in more detail.\footnote{
The literature 
on DM
often uses $\rvz^{t-1}$ 
instead of $\rvw^{t}$.
Note that 
the time index
of 
$\rvw^{t}$
often does not matter
because 
$\rvw^{t}\sim \caln(0, I)$
for all $t$.
This does not mean
that we can drop the
time index of $\rvw^t$,
because $\rvw^{t_1}$
and $\rvw^{t_2}$
are uncorrelated for $t_1\neq t_2$,
so we can get into 
trouble if we assume
$\rvw^{t_1}=\rvw^{t_2}$ .
}

\begin{figure}[h!]
$$
\xymatrix@C=4pc@R=3pc{
&\rvw^1\ar[d]^{\sqrt{\beta^0}}
&\rvw^2\ar[d]^{\sqrt{\beta^1}}
&\rvw^3\ar[d]^{\sqrt{\beta^2}}
\\
\rvx^0\ar[r]_{\sqrt{\alp^0}}
&\rvx^1\ar[r]_{\sqrt{\alp^1}}
&\rvx^2\ar[r]_{\sqrt{\alp^2}}
&\rvx^3(= \TIL{\rvx}^3)\ar[dl]
\\
\TIL{\rvx}^0
&\TIL{\rvx}^1\ar[l]
&\TIL{\rvx}^2\ar[l]
&
}
$$
\caption{Bnet for DM with $T=3$.}
\label{fig-diffusion1}
\end{figure}


The TPMs, printed in blue,
for the bnet of Fig.\ref{fig-diffusion1}
are as follows:

\beq \color{blue}
P(x_0)=\delta(x_0, x'_0)
\quad \text{ (original image) }
\eeq

\beq \color{blue}
P(x^t|x^{t-1}, w^{t})=
\indi(\quad x^t=\sqrt{\alp^t}\;x^{t-1}
+\sqrt{\beta^t}\;w^{t}\quad)
\eeq

\beq \color{blue}
P(w^t) = \caln(w^t; \mu=0,
 \s^2 =  I ) \quad \text{(white noise)}
\eeq

\beqa \color{blue}
P(\TIL{\rvx}^{t-1}=x^{t-1}|\TIL{\rvx}^{t}=x^{t})&=&\color{blue}
\tilPT(x^{t-1}|x^{t})
\\
&=&\color{blue}
\caln(x^{t-1}; \mu=M^{t-1}_\theta(x^t),
\s^2 =\Sigma_\theta^{t-1}(x^t))
 \eeqa
We will assume,
that 

\beq
\Sigma_\theta^{t-1}(x^t)
=
(\s^{t-1})^2 I
\eeq
where $\s^{t-1}\in \RR$.
 
 \begin{figure}[h!]
 $$
 \xymatrix@C=4pc@R=3pc{
 &\rvw^1\ar[d]^{\sqrt{\beta^0}}
 &\rvw^2\ar[d]^{\sqrt{\beta^1}}
 &\rvw^3\ar[d]^{\sqrt{\beta^2}}
 \\
 \rvx^0\ar[r]_{\sqrt{\alp^0}}
 &\rvx^1\ar[r]_{\sqrt{\alp^1}}
 &\rvx^2\ar[r]_{\sqrt{\alp^2}}
 &\rvx^3(= \TIL{\rvx}^3)\ar[ddl]\ar[dddl]
 \\
 \TIL{\rvx}^0
 &\TIL{\rvx}^1\ar[dl]\ar[ddl]
 &\TIL{\rvx}^2\ar[dl]\ar[ddl]
 \\
 \rva^0\ar[u]^{1}
 &\rva^1\ar[u]^{1}
 &\rva^2\ar[u]^{1}
 \\
 \rvn_\theta^0\ar@/_1pc/[uu]_{-1}
 &\rvn_\theta^1\ar@/_1pc/[uu]_{-1}
 &\rvn_\theta^2\ar@/_1pc/[uu]_{-1}
 }
 $$
 \caption{The bnet of Fig.\ref{fig-diffusion1}
 shown in more detail.}
 \label{fig-diffusion2}
 \end{figure}
 
 
 The TPMs, printed in blue,
 for the bnet of Fig.\ref{fig-diffusion2}
 are as follows:
 \beq \color{blue}
 P(n_\theta^t) = \caln(n_\theta^t; \mu=M^t_\theta(x^{t+1}),
  \s =  \s^t )
 \eeq
 
\beq \color{blue}
 P(a^t|\TIL{\rvx}^{t+1}=x^{t+1}) = \indi(\quad
 a^t= M^t(x^{t+1})
 \quad)
 \eeq
 
\beq \color{blue}
 P(\TIL{\rvx}^t=x^t|
 a_t,
 n_\theta^t
 ) = \indi(\quad
 x^t= 
 a^t-
  n_\theta^t
 \quad)
 \eeq
 
 \beq
\underbrace{ P(
\TIL{\rvx}^t=x^t|
 \TIL{\rvx}^{t+1}=x^{t+1}
 )
 }_{ \tilPT(x^t|x^{t+1})}
 =\quad
 \caln(x^t;
 \mu= M^t(x^{t+1})
 -M^t_\theta(x^{t+1}),
 \s=\s^t)
 \eeq
 
 \section{Mean Values $M^{t-1}(x^t)$ 
 and $M^{t-1}_\theta(x^t)$ }
 \begin{claim}
 \beq
 \boxed{
 \rvx^t = \sqrt{\prodalp}\; \rvx^{0}
 +\sqrt{1-\prodalp}\;\rvw^t}
 \label{eq-xt-x0-w}
 \eeq
 
\beq
 \xymatrix@C=5pc@R=3pc{
 &\rvw^t\ar[d]^{\sqrt{1-\prodalp}}
 \\
 \rvx^0\ar[r]_{\sqrt{\prodalp}}
 & \rvx^t
 }
 \eeq

 \end{claim}
 \proof
 
 Recall that when 
 you multiply two Gaussians
 with variances $V_1$ and $V_2$,
 the variance of the
 product is $V_1+V_2$.
 We'll call this property
 the Variance of Gaussian Product (VGP).
 Let $\rvw \sim \caln(0,I)$.
 
 
 \beqa
 \rvx^t 
 &=& 
 \sqrt{\alp^t} \rvx^{t-1}
 + \sqrt{1-\alp^t}\;\rvw^t
 \\
 &=&
 \sqrt{\alp^t} 
 [\sqrt{\alp^{t-1}} \rvx^{t-2}
  + \sqrt{1-\alp^{t-1}}\;\rvw^{t-1}]
  + \sqrt{1-\alp^t}\;\rvw^t
  \\
  &=&
\sqrt{\alp^t\alp^{t-1}}\; \rvx^{t-2}
+ 
[ \sqrt{\alp^t(1-\alp^{t-1})}\;\rvw^{t-1}
  + \sqrt{1-\alp^t}\;\rvw^t]
  \\
  &=&
 \sqrt{\alp^t\alp^{t-1}}\; \rvx^{t-2}
 + 
 \sqrt{1-\alp^t\alp^{t-1}}\;\rvw
 \quad \text{(by VPG)}
 \\
 &=& \cdots
 \\
 &=&
 \sqrt{\prodalp}\; \rvx^{0}
  + 
  \sqrt{1-\prodalp}\;\rvw
 \eeqa
 Now replace
 $\rvw$ by $\rvw^t$.
 This is justified
 because they are 
 both $\caln(0,I)$.
 
 
 \qed
 
  Solving Eq.(\ref{eq-xt-x0-w}) 
  for $\rvx^0$, we get
  \beq
  \boxed{
  \rvx^0 = \frac{1}{\sqrt{\prodalp}}
  \rvx^t
  -
  \frac{\sqrt{1-\prodalp}}
  {\sqrt{\prodalp}}\rvw^t
  }
  \label{eq-x0-xt-w}
  \eeq

 \beq
 \xymatrix@C=5pc@R=3pc{
 &\rvw^t\ar[dl]
 _{\frac{\sqrt{1-\prodalp}}
   {\sqrt{\prodalp}}}
 \\
 \rvx_0
 & \rvx^t\ar[l]^{\frac{1}{\sqrt{\prodalp}}}
 }
 \eeq
  
 
 \begin{claim}
 \beq
 P(x^{t-1}|x^{t}, x^0)=
 P(x^t|x^{t-1})
 \frac
 {P(x^{t-1}|x^0)}
 {P(x^t|x^0)}
 \eeq
 \end{claim}
 \proof
 \beq
 \overbrace{
 P(x^t|x^{t-1}, x^0)}
 ^{P(x^t|x^{t-1})}P(x^{t-1}|x^0)
 =
 P(x^{t-1}|x^{t}, x^0)P(x^t|x^0)
 \eeq
 \beq
 \begin{array}{l}
 \xymatrix{
 &\sum w^1\ar[d]
 &\cdots
 &\sum w^{t-1}\ar[d]
 &\sum w^{t}\ar[d]
 \\
 x^0\ar[r]
 &\sum x^1\ar[r]
 &\cdots\ar[r]
 &x^{t-1}\ar[r]
 &x^t
 }
 \\
 \\
 =
 \xymatrix{
 x^0\ar[r]
 &x^{t-1}\ar[r]
 &x^{t}
 }
  \\
  \\
  =
  \xymatrix{
  x^0\ar[r]\ar@/_1pc/[rr]_0
  &x^{t-1}\ar[r]
  &x^{t}
  }\quad\text{(make fully connected)}
 \\
 \\
 =
 \xymatrix{
 x^0\ar[r]\ar@/_1pc/[rr]
 &x^{t-1}
 &x^{t}\ar[l]
 }\quad\text{(reverse arrow)}
 \end{array}
 \eeq
 
 \beq
 P(x^t|x^{t-1})P(x^{t-1}|x^0)
 =
 P(x^{t-1}|x^{t}, x^0)P(x^t|x^0)
 \eeq
 \qed
 
 \beq
 M^{t-1}(x^t)=
 \sum_{x^{t-1}}
 x^{t-1}P(x^{t-1}|x^t, x^0)
 \eeq
 
 \begin{claim}
 \beq
 \boxed{
 M^{t-1}(x^t)
 =
 \frac{\sqrt{\alp^t}
 (1-\pi_1^{t-1}\alp)}
 {1-\prodalp}
 x^t
 +
 \frac{\sqrt{\pi_1^{t-1}\alp}\;\beta^t}
  {1-\prodalp}
  x^0
  }
  \label{eq-m-t-1}
 \eeq
 \end{claim}
 \proof
 \qed
 


\begin{claim}
\beq
\boxed{
M^{t-1}(x^t)=
 \frac{1}{\sqrt{\alp^t}}
 \left(
 x^t-
 \frac{\beta^t}
 {\sqrt{1-\prodalp}}
 w^t
 \right)
 }
 \eeq
 \end{claim}
 \proof
 
 Use Eq.(\ref{eq-x0-xt-w})
 to replace $x^0$ in 
 Eq.(\ref{eq-m-t-1}).
 \qed


 
 Parameterize $M^{t-1}(x^t)$ by
 
 \beq
 \boxed{
 M^{t-1}_\theta(x^t)=
  \frac{1}{\sqrt{\alp^t}}
  \left(
  x^t-
  \frac{\beta^t}
  {\sqrt{1-\prodalp}}
  n^{t-1}_\theta(x^t)
  \right)}
 \eeq
 
 Let
 \beq
 C^t=
 \frac{-\beta^t}
   {\sqrt{\alp^t(1-\prodalp)}}
   \eeq
 Then 
 
 \beqa
 M^{t-1}(x^t)- M^{t-1}_\theta(x^t)
 &=&
C^t
[w-n^{t-1}_\theta(x^t)]
\\
&=&
C^t
[w^t-n^{t-1}_\theta(
\sqrt{\alp^t}\; x^{0}
 +\sqrt{1-\prodalp}\;w^t
)]
\eeqa

\section{Loss function ${\cal L}$}
\beqa
0&\leq&
 D_{KL}(P(x^{1:T}|x^0)
\parallel \tilPT(x^{1:T}|x^0))
\\
&=&
\sum_{x^{1:T}}
P(x^{1:T}|x^0)
\ln
\frac{P(x^{1:T}|x^0)}
{\tilPT(x^{1:T}|x^0)}
\\
&=&
\ln \tilPT(x^0)
+
\sum_{x^{1:T}}
P(x^{1:T}|x^0)
\ln
\frac{P(x^{1:T}|x^0)}
{\tilPT(x^{0:T})}
\eeqa

\beq
\underbrace{
-\sum_{x^0}P(x^0)\ln\tilPT(x^0)
}_{-E_{x^0}[\ln \tilPT(x^0)]}
\leq
\underbrace{
\sum_{x^{0:T}}
P(x^{0:T})
\ln
\frac{P(x^{1:T}|x^0)}
{\tilPT(x^{0:T})}}_{
E_{x^{0:T}}\left[\ln
\frac{P(x^{1:T}|x^0)}
{\tilPT(x^{0:T})}
\right]=\call(\theta)}
\eeq

Henceforth, expected values $E_{x^{0:T}}$
are to be understood as being with respect
to $P(x^{0:T})$.

\begin{claim}
\beq
\call = \sum_{t=0}^T\call^t
\eeq

\beq
\call^0 =
-\ln \tilPT(x^0|x^1)
\eeq

\beq
\call^{t-1}=
E_{x^{0:T}}\left[\ln
\frac{P(x^{t-1}|x^t,x^0)}
{\tilPT(x^{t-1}|x^t)}
\right]
\quad \text{ for } t=2, 3, \ldots T
\eeq

\beq
\call^T =
E_{x^{0:T}}\left[\ln
\frac{P(x^T|x^0)}
{\tilPT(x^T)}
\right]
\eeq

\end{claim}
\proof
\beqa
\call
&=&
E_{x^{0:T}}
\left[\ln 
\frac{P(x^{1:T}|x^0)}
{\tilPT(x^{0:T})}
\right]
\\
&=&
E_{x^{0:T}}
\left[\ln 
\frac{\prod_{t=1}^T P(x^t|x^{t-1})}
{\tilPT(x^T)
\prod^T_{t=1}\tilPT(x^{t-1}|x^t)}
\right]
\\
&=&
E_{x^{0:T}}
\left[\ln 
\frac{P(x^1|x^{0})\prod_{t=2}^T \overbrace
{P(x^t|x^{t-1})}
^{P(x^t|x^{t-1},x^0)}
}
{\tilPT(x^T)\tilPT(x^0|x^1)
\prod^T_{t=2}\tilPT(x^{t-1}|x^t)}
\right]
\\
&=&
E_{x^{0:T}}
\left[\ln 
\frac{P(x^1|x^{0})\prod_{t=2}^T 
P(x^{t-1}|x^t, x^0)
\frac{P(x^t|x^0)}
{P(x^{t-1}|x^0)}
}
{\tilPT(x^T)\tilPT(x^0|x^1)
\prod^T_{t=2}\tilPT(x^{t-1}|x^t)}
\right]
\\
&=&
E_{x^{0:T}}
\left[\ln 
\frac{
\cancel{P(x^1|x^{0})}
\frac{P(x^T|x^0)}
{\cancel{P(x^1|x^0)}}
\prod_{t=2}^T 
P(x^{t-1}|x^t, x^0)
}
{\tilPT(x^T)\tilPT(x^0|x^1)
\prod^T_{t=2}\tilPT(x^{t-1}|x^t)}
\right]
\\
&=&
E_{x^{0:T}}
\left[\ln 
\frac{1}
{\tilPT(x^0|x^1)}
\cdot
\frac{P(x^T|x^0)}
{\tilPT(x^T)}
\cdot
\frac{
\prod_{t=2}^T 
P(x^{t-1}|x^t, x^0)
}{
\prod^T_{t=2}\tilPT(x^{t-1}|x^t)
}
\right]
\eeqa
\qed


\begin{claim}
\beqa
\call^{t-1}
&=&
E_{x^0, w^t}
\left[
\frac{1}{2(\s^{t-1})^2}
[M^{t-1}(x^t)-M^{t-1}_\theta(x^t)]^2
\right]
\\
&=&
E_{x^0, w^t}
\left[
\frac{(C^t)^2}{2(\s^{t-1})^2}
\left
[w^t-n^{t-1}_\theta(
\sqrt{\prodalp}\; x^{0}
 +\sqrt{1-\prodalp}\;w^t
)\right]^2
\right]
\eeqa
\end{claim}
\proof
\qed

\beq
\call_{simple} =
E_{x^0, w^t}
\left[
\left
[w^t-n^{t-1}_\theta(
\sqrt{\prodalp}\; x^{0}
 +\sqrt{1-\prodalp}\;w^t
)\right]^2
\right]
\eeq

\section{Algorithms for training
and sampling }
