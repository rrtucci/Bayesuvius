\chapter{Kalman Filter}\label{ch-kalman}

A Kalman Filter (KF) is a special case of a
Hidden Markov Model. HMMs are
 discussed in Chapter \ref{ch-hmm}.

\begin{figure}[h!]
\centering
$$\xymatrix{
&\rvu_1\ar[dr]
&*++[F-o]{\rvw_1}\ar[d]
&\rvu_1\ar[dr]
&\cdots
&\rvu_{t-1}\ar[dr]
&*++[F-o]{\rvw_{t-1}}\ar[d]
&\rvu_t\ar[dr]|{B_t}
&*++[F-o]{\rvw_{t}}\ar[d]^{Q_t}
\\
*++[F-o]{\rvx_0}\ar[d]\ar[rr]
&&*++[F-o]{\rvx_1}\ar[d]\ar[rr]
&&\cdots
&&*++[F-o]{\rvx_{t-1}}\ar[d]\ar[rr]_{A_t}
&&*++[F-o]{\rvx_{t}}\ar[d]^{H_t}
\\
\rvz_0
&&\rvz_1
&&\cdots
&&\rvz_{t-1}
&
&\rvz_{t}
\\
*++[F-o]{\rvv_0}\ar[u]
&&*++[F-o]{\rvv_1}\ar[u]
&&\cdots
&&*++[F-o]{\rvv_{t-1}}\ar[u]
&&*++[F-o]{\rvv_{t}}\ar[u]_{R_t}
}$$
\caption{Kalman Filter (KF) bnet.}
\label{fig-kal}
\end{figure}

Let 

$t=0, 1, 2, \dots , T-1$ be the time.

$\rvw_t\in\RR, \rvv_t\in \RR$ be
random variables that represent
hidden (unobserved)   external
Gaussian white noise.

$\rvx_t\in S_\rvx$ be
random variables that represent
the hidden (unobserved) true
state of the system.

$\rvu_t\in S_\rvu, \rvz_t\in S_\rvz$ be
random variables that represent
the measured (observed) state of the system.


The 
node TPMs,
printed in blue,
of the KF bnet Fig.\ref{fig-kal},
are as follows:

\beq\color{blue}
P(w_t)=\caln(w_t; 0, Q_t)
\;,
\eeq
where $Q_t$ is given.


\beq\color{blue}
P(x_t|x_{t-1}, u_t, w_t)=
\indi(x_t=A_tx_{t-1} + B_tu_t + w_t)
\;,
\eeq
where $A_t, B_tu_t$
are given. $P(x_t|x_{t-1})$ becomes $P(x_t)$
for $t=0$.

\beq\color{blue}
P(v_t)=\caln(v_t; 0, R_t)
\;,
\eeq
where $R_t$ is given.

\beq\color{blue}
P(z_t|x_t, v_t)=
\indi(z_t=H_t x_t +  v_t)
\;,
\eeq
where $H_t$ is given.


\section{Prediction
Problem}
Find $\hatx_t$ (the 
best possible estimate
of $x_t$)
and $P_t$ (the state of the 
filter at time $t$)
in terms of 
\begin{enumerate}
\item
$\hatx_{t-1}$
and $P_{t-1}$.
\item
 the 5 matrices
$\calm_t=(A_t,B_t,H_t,Q_t,R_t)$
\item
the observed  values of 
$z_t$ and $u_t$.

\end{enumerate}
See Fig.\ref{fig-kal-evol}.
For that figure,

\beq \color{blue}
P(\hatx_t, P_t | 
\hatx_{t-1}, P_{t-1},
\calm_t,
z_t,u_t)
=\delta(\hatx_t,?)
\delta(P_t, ?)
\;.
\eeq

\begin{figure}[h!]
\centering
$$\xymatrix{
\calm_0, \rvz_0,\rvu_0\ar[d]&
\calm_1, \rvz_1,\rvu_1\ar[d]&
\calm_2, \rvz_2,\rvu_2\ar[d]&
\calm_3, \rvz_3,\rvu_3\ar[d]
\\
\ul{\hatx}_0, 
\ul{P}_0\ar[r]&
\ul{\hatx}_1, 
\ul{P}_1\ar[r]&
\ul{\hatx}_2, 
\ul{P}_2\ar[r]&
\ul{\hatx}_3, 
\ul{P}_3
}$$
\caption{Evolution of
$\hatx_t, P_t$ for a KF.}
\label{fig-kal-evol}
\end{figure}

\section{
Solution} 

The algebraic solution\footnote{This
algebraic
 solution was copied from 
Wikipedia Ref.\cite{wiki-kalman},
with $F_t$ replaced by $A_t$.}
of
the prediction problem
for a KF 
is as follows.
See Fig.\ref{fig-kal-evol-plus}
for a bnet representation
of this algebraic
solution.

\begin{figure}[h!]
$$
\xymatrix@C=5pc{
P_{t-1}\ar[r]
&P_{t|t-1}\ar[r]\ar[rd]
&P_t
\\
&&
K_t\ar[u]
\\
u_{t-1}
&
&u_t\ar[ld]|{B_t}
\\
\hatx_{t-1}\ar[r]^{A_t}
&\hatx_{t|t-1}\ar[r]^1
\ar[d]_{-H_t}
&\hatx_t\ar[d]^{-H_t}
\\
\tilde{y}_{t-1}
&\tilde{y}_{t|t-1}\ar[ru]|{K_t}
&\tilde{y}_t
\\
z_{t-1}
&
&z_t\ar[lu]^1
\ar[u]_1
}
$$
\caption{Bnet representation
of the algebraic
solution of
the prediction 
problem for a KF.}
\label{fig-kal-evol-plus}
\end{figure}


Define $\eta_{t|t}=\eta_t$ for 
$\eta=\hatx, P$.

\begin{itemize}
\item{\bf A priori estimates}

a priori state estimate
\beq
\hatx_{t| t-1} =
 A_t
\hatx_{t-1}
 + B_t u_{t}
\eeq

a priori covariance estimate
\beq
P_{t| t-1} =
 A_t 
P_{t-1}
 A_t^\textsf{T} +
 Q_t
\eeq

\item{\bf A posteriori estimates}



Optimal Kalman gain

\beq
S_t = H_t 
P_{t| t-1} 
H_t^\textsf{T} +
 R_t
\eeq

\beqa
K_t &=&
P_{t| t-1}
H_t^\textsf{T}
 S_t^{-1}
\\
&=&
 P_{t| t-1}
H_t^\textsf{T}
\left[
H_t 
P_{t| t-1} 
H_t^\textsf{T} +
 R_t
\right]^{-1}
\eeqa


a posteriori state estimate

\beq
\tilde{y}_{t|t-1}= 
\underbrace{z_t}_{H_t x_t + v_t} - 
H_t\hatx_{t| t-1}
\eeq

\beqa
\hatx_{t} &=&
 \hatx_{t| t-1} +
 K_t\tilde{y}_{t|t-1}
\\
&=&
(1-K_tH_t)\hatx_{t| t-1} +
 K_t\underbrace{z_t}_{H_t x_t + v_t}
\quad\text{(interpolation formula)}
\eeqa

\beq
\tilde{y}_{t} =
\underbrace{z_t}_{H_t x_t + v_t} - H_t
\hatx_{t} \quad\text{($\tilde{y}_t$ is a residual)}
\eeq

a posteriori covariance estimate
\beq
P_{t} = \left(I -
 K_t H_t\right) 
P_{t|t-1} 
\eeq



\end{itemize}
