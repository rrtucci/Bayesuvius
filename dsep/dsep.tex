\chapter{D-Separation}
\label{ch-dsep}
Before reading this chapter,
I  recommend
that you
read
Chapter \ref{ch-bnet-def}
on the definition of bnets.


A path $\gamma$ that
isn't a loop can have 
3 types of intermediate nodes $\rvx$ (
an intermediate node of $\gamma$
 is a node in $\gamma$ that 
isn't one
of the two end nodes).
Suppose $\rva$ and $\rvb$
are the two neighbors of $\rvx$. Then
the 3 possible cases are:
\begin{enumerate}
\item {\bf mediator node:}
$(\rva\larrow\rvx\larrow \rvb)$
or
$(\rva\rarrow\rvx\rarrow \rvb)$
\item {\bf fork node:}
$(\rva\larrow\rvx\rarrow \rvb)$
\item {\bf collider node:}
$(\rva\rarrow\rvx\larrow \rvb)$
\end{enumerate}

We say that a non-loop path 
$\gamma$ 
from $\rva$ to $\rvb$ (i.e., with
end nodes $\rva, \rvb$)
is {\bf blocked}
by a multinode $\rvZ.$
if one or more 
of the following
statements is true:

\begin{enumerate}
\item 
There is a node $\rvx\in \rvZ.$
which is a mediator 
or a fork of $\gamma$.
\item
$\gamma$ contains a collider
node $\rvc$
and 
$(\rvc\cup de(\rvc))\cap\rvZ.=\emptyset$
(i.e., neither 
$\rvc$ nor 
any of the descendants of $\rvc$
is contained in $\rvZ.$)
\end{enumerate}

This definition of a blocked 
path is easy to remember
if one thinks 
of the following analogy
with pipes carrying a fluid.
Think of path
$\gamma$ as if it
were a pipe
carrying a fluid.
Think of
the nodes 
of $\gamma$ as junctions in the pipe.
If $\rvZ.$
intersects $\gamma$
at either a mediator
or a fork junction,
that blocks the pipe flow.
A collider junction $\rvc$
is like a blackhole 
or a huge leak.
Its presence
blocks passage
of the fluid
as long
as neither
$\rvc$
nor any of
the descendants 
of $\rvc$
are in $\rvZ.$.
If,
on the 
other hand,
$\rvc\in\rvZ.$,
or $\rvc'\in \rvZ.$
where $\rvc'\in de(\rvc)$,
then
that acts
as a complete
(in the case of $\rvc\in\rvZ.$)
or a partial 
(in the case of $\rvc'\in\rvZ.$)
bridge across the blackhole.

See Fig.\ref{fig-blocked-paths}
for some examples of
paths that are blocked or not blocked
by a multinode $\rvZ.$.

\begin{figure}[h!]
\beqa
\xymatrix{
\circ\ar[r]
&\circ\ar[r]
&\circ\ar[r]
&\circ\ar[r]
&\circ
}&\text{Not Blocked}
\\
\xymatrix{
\circ\ar[r]
&\color{red}\bullet\ar[r]
&\circ\ar[r]
&\circ\ar[r]
&\circ
}&\text{Blocked}
\\
\xymatrix{
\circ
&\circ\ar[l]\ar[r]
&\circ\ar[r]
&\circ\ar[r]
&\circ
}&\text{Not Blocked}
\\
\xymatrix{
\circ
&\color{red}\bullet\ar[l]\ar[r]
&\circ\ar[r]
&\circ\ar[r]
&\circ
}&\text{Blocked}
\\
\xymatrix{
\circ\ar[r]
&\circ\ar[r]
&\circ
&\circ\ar[l]\ar[r]
&\circ
}&\text{Blocked}
\\
\xymatrix{
\circ\ar[r]
&\circ\ar[r]
&\color{red}\bullet
&\circ\ar[l]\ar[r]
&\circ
}&\text{Not Blocked}
\\
\xymatrix{
\circ\ar[r]
&\circ\ar[r]
&\circ\ar[d]
&\circ\ar[l]\ar[r]
&\circ
\\
&&\color{red}\bullet
}&\text{Not Blocked}
\eeqa
\caption{Examples of 
paths that are blocked
or not blocked
by a multinode $\rvZ.$. Nodes
belonging to 
$\rvZ.$
are colored red.}
\label{fig-blocked-paths}
\end{figure}

Given 3 
disjoint multinodes 
$\rvA., \rvB., \rvZ.$
of a graph $G$,
we write ``
$\rvA.\perp_G \rvB.|\rvZ.$"
or say `` {\bf$\rvA.$ and
$\rvB.$ are d-separated
by $\rvZ.$ in $G$}"
iff there exists 
no path
$\gamma$ from
$\rva\in \rvA.$,
to
$\rvb\in\rvB.$
which is not 
blocked by $\rvZ.$.\footnote{
$\rvZ.$ are the nodes
we are ``conditioning on".
Unmeasured (i.e., hidden,  unobserved) 
nodes cannot be
conditioned on, because
that would entail
measuring them.
} 

The minimal 
Markov blanket (see Chapter
\ref{ch-mblanket})
of a node $\rva$
is the smallest 
multinode $\rvZ.$
such that $\rva\perp_G\rvb|\rvZ.$
for all $\rvb\notin \rva\cup\rvZ.$.

We are finally ready
to state the d-separation
theorem, without proof.

A
 probability
distribution
{\bf $P$
is 
compatible 
with a DAG $G$}
if $P$ and $G$ 
have the same
random variables, and they 
can be
combined to form a bnet
without
contradictions;
i.e.,
one can calculate 
all
the TPMs from $P$
and multiply
them 
together to
obtain $P$ again.

\begin{claim}(d-separation Theorem)

Suppose
$\rvA., \rvB., \rvZ.$
are disjoint multinodes
of a DAG  $G$.

If 
$\rvA.\perp_G \rvB.|\rvZ.$, then
$P(B.|A., Z.)=P(B.|Z.)$
for all $B.,A., Z.$,
for all $P$
compatible with $G$.

\end{claim}
The full converse
of the theorem can also be 
proven, 
but we won't be using it
in this book.

Often, the right hand side
of this theorem is stated as 
``$\rvA.\perp_P \rvB.|\rvZ.$
for all $P$".
Then the theorem is stated:
``If 
$\rvA.\perp_G \rvB.|\rvZ.$, then
$\rvA.\perp_P \rvB.|\rvZ.$ for all $P$."  

\hrule
Note that 
the following are equivalent:
\begin{itemize}
\item
$P(B.|A., Z.)=P(B.|Z.)$ for all $B., A., Z.$.
\item
$\rvA.\perp_P \rvB.|\rvZ.$
\item
$H(\rvA.:\rvB.|\rvZ.)=0$
(see Chapter \ref{ch-not-cons}
for definition of
 conditional mutual information (CMI))
\end{itemize}
\hrule\noindent
{\bf Extra stuff: mostly only for 
 pure mathematicians}

Below, we will use
the notation $nde(\rva)$
to denote
all nondescendants,
including $\rva$ itself, 
of a node $\rva$
in a DAG $G$; i.e.,
all nodes of $G$ that are not
in $de(\rva)\cup \rva$, where
$de(\rva)$
is defined in Chapter \ref{ch-bnet-def}.

Given a DAG $G$, define 
the following
sets of d-separations:\footnote{
Note that
$(\rvA.\perp_G
nde(\rvA.)\cond pa(\rvA.))$ and
$(\rvA.\perp_G
nde(\rvA.)-pa(\rvA.)\cond pa(\rvA.))$
are
equivalent
because
$H(\rva:\rvb, \rvc|\rvc)=
H(\rva:\rvb|\rvc)$.
}
\beq
DS(G)=\{(\rvA.\perp_G\rvB.\cond\rvZ.):
\text{ $\rvA.,\rvB.,\rvZ.$ are multinodes of $G$\}}
\;.
\eeq
\beq
DS_{min}(G)=\{(\rvA.\perp_G
nde(\rvA.)\cond pa(\rvA.)):
\text{ $\rvA.$ is a multinode of $G$\}}
\;.
\eeq

See Chapter \ref{ch-obs-equi}
for an example
where set $DS_{min}(G)$
is calculated for 
a particular DAG $G$.

\begin{claim}
For all DAGs $G$, $DS(G)=DS_{min}(G)$.
\end{claim}

Given a probability distribution  $P$, 
define the following
set of conditional independencies:

\beq
CI(P)=\{(\rvA.\perp_P\rvB.\cond \rvZ.):
\text{ $\rvA.,\rvB.,\rvZ.$ are multinodes of $P$\}}
\;,
\eeq


For a DAG $G$
and a probability
distribution $P$
compatible with $G$,
define  a map $\phi$
by
\beqa
\phi:DS_{min}(G) &\rarrow& CI(P)
\\
\phi: \rvA.\perp_G nde(\rvA.)\cond pa(\rvA.)
&\mapsto&
\rvA.\perp_P nde(\rvA.)\cond pa(\rvA.)
\eeqa
In general, this map
is 1-1 but not onto.


\begin{claim}
For a bnet 
with a DAG $G$
and a total probability distribution $P$,
the map $\phi$ is a bijection.
\end{claim}

$DS(G)$
does not fully specify a DAG.
DAGs with the same 
$DS(G)$ are said to be
{\bf d-separation equivalent}.
See Chapter \ref{ch-obs-equi}
for more info about 
d-separation equivalence.