\chapter{Do Calculus proofs}
\label{ch-do-calc-proofs}

In Chapter \ref{ch-do-calc}
of Bayesuvius,
we explained Do Calculus
but referred to this
chapter for proofs
of claims that
use Do Calculus.
In this chapter, we've
aggregated
 all proofs, from
throughout the book,
of claims that use Do Calculus.

Note that even though the 3
rules of Do Calculus
are great for proving
adjustment formulae
for general classes of DAGs,
they are sometimes overkill
for proving
 adjustment formulae
for a single specific DAG.
After all,  the
 3 rules of Do Calculus
are a consequence
of the d-separation theorem.
Hence, all adjustment
formulae should be
provable from first principles,
assuming only
the d-separation theorem
and the standard rules of
probability theory.

We use the
 following conventions.
Random variables are underlined
and their values are not.
For example, $\rva=a$ means
the random variable
$\rva$ takes the value $a$.
Diagrams
with nodes that are
underlined represent
Bayesian Networks (bnets)
and the same diagram
with the letters not underlined
represents a specific
instantiation of that bnet.
For example $\rva\rarrow\rvb$
represents the bnet with
conditional probability distribution
$P(b|a)$,
whereas  $a\rarrow b$
represents $P(b|a)$ itself.

If $\rva$ is a root node,
then $\sum a$ signifies
a weighted sum $\sum_a P(a)$.
For example, $\sum a\rarrow b=\sum_a P(a)P(b|a)$.
If $\rva$ is not
a root node
as in $x\rarrow\sum a \rarrow y=
\sum_a P(y|a)P(a|x) $, then
$\sum a$ signifies
a simple unweighted sum $\sum_a$.

Unobserved nodes are
indicated by enclosing them
in a dashed circle. For example,
$\xymatrix{*++[F-o]{u}}$.

Selection nodes are discussed 
in Chapter \ref{ch-transport}.
For a selection node $\rvs\in\bool$,
\selectionGraphs

Here is an  identity
that we will use frequently:

\beq
P(y|x_1, x_2)= 
\sum_a P(y|a, x_1, x_2)P(a|x_1, x_2)
\;.
\eeq
This identity
can be represented graphically
by

\beq
\xymatrix{
x_1\ar[rrd]
\\
&&y
\\
x_2\ar[urr]
}
\xymatrix{\\=}
\xymatrix{
x_1\ar[rd]\ar[drr]
\\
&\sum a\ar[r]
&y
\\
x_2\ar[ru]\ar[rru]
}
\label{eq-proofs-nonroot}
\;.
\eeq
One can describe
this identity as
``giving $\rvy$
a universal backdoor", 
because $\sum a$ is a backdoor
(i.e., input) to $y$, and $\sum a$
is universal in the sense that it
 is entered
by every arrow that enters $y$
except $\sum a$ itself.



\begin{claim} 
\label{cl-decBackDoor}
\decBackDoor
\end{claim}

\proof

{\bf * proof 1:}
\begin{longtable}{l}
\color{red}
$P(y|\cald\rvx=x)=\sum_z
 P(y|\cald \rvx=x, z)P(z|\cald\rvx =x)$
\\
$\xymatrix{
\sum z\ar[dr]
\\
\cald \rvx=x\ar[r]
&y
}
\xymatrix{\\=}
\xymatrix{
\sum z\ar[dr]
\\
\cald \rvx=x\ar[r]\ar[u]|0
&y
}
$
\\
\color{red}
$=\sum_z P(y|x,z)P(z|\cald\rvx=x)$
\\
\xymatrix{\\=}
\xymatrix{
\sum z\ar[dr]
\\
\cald \rvx=x\ar[u]|0
&y
\\x\ar[ur]
}
\begin{tabular}{l}
\\
\\
by Rule 2
\end{tabular}
\\
\color{red}
$=\sum_z P(y|x,z)P(z)$
\\
\xymatrix{\\
=}
\xymatrix{
\sum z\ar[dr]
\\
x\ar[r]
&y
}
\begin{tabular}{l}\\
\\
by Rule 3.
\\
No info transmission\\
between $\cald\rvx$ and $\rvz$.
\end{tabular}
\end{longtable}


{\bf * proof 2:}
\begin{longtable}{l}
\color{red}
$P(y|\cald\rvx=x)
=
\sum_z
P(y|\cald\rvx=x, z)
P(z|\cald\rvx=x)$
\\
\quad by Probability Axioms
\\
\color{red}
$=\sum_z
P(y|x, z)
P(z|\cald\rvx=x)$
\\
\quad $P(y|\cald \rvx=x, z)\rarrow
P(y|x, z)$
\\
\quad  by Rule 2:
\begin{tabular}{l}
\ruletwoif\\\ruletwothen
\end{tabular}
\\
\quad
$\rvy\perp\rvx|\rvz$ in
$\call_\rvx\cald_\emptyset G:
\xymatrix{
\rvz\ar[d]\ar[rd]
\\
\rvx
&\rvy
}$
\\
\color{red}
$=\sum_z
P(y|x, z)
P(z)$
\\
\quad $P(z|\cald \rvx=x)\rarrow
P(z)$
\\
\quad  by Rule 3:
\begin{tabular}{l}
\rulethreeif\\\rulethreethen
\end{tabular}
\\
\quad
$\rvz\perp \rvx$ in
$\cald_\rvx \cald_\emptyset G:
\xymatrix{
\rvz\ar[rd]
\\
\rvx\ar[r]
&\rvy
}
$
\end{longtable}
\qed


\begin{claim}
\label{cl-decFrontDoor}
\decFrontDoor
\end{claim}

\proof


{\bf * proof 1:}
\\
\begin{longtable}{l}
$\color{red}
P(y|\cald\rvx=x)=
\sum_{m}
P(y|\cald\rvx=x, m)
P(m|\cald\rvx=x)$
\\
\\
\xymatrix{
&*++[F-o]{\sum c}\ar[rd]
\\
\cald \rvx=x\ar[r]
&\sum m\ar[r]
&y
}
\xymatrix{\\=}
\xymatrix{
\cald \rvx=x\ar[r]\ar@/_1.2pc/[rr]|0
&\sum m\ar[r]
&y
}
\\
$\color{red}=
\sum_{m}
P(y|\cald\rvx=x, \cald\rvm=m)
P(m|\cald\rvx=x)$
\\
\xymatrix{\\=\sum_m }
\xymatrix{
\cald \rvx=x\ar[r]\ar@/_1.2pc/[rr]|0
&m&y
\\
&\cald\rvm=m\ar[ru]
}
\begin{tabular}{l}
\\
by Rule 2
\end{tabular}
\\
$\color{red}=
\sum_{m}
P(y|\cald\rvx=x, \cald\rvm=m)
P(m| x)$
\\
\xymatrix{\\=\sum_m }
\xymatrix{
\cald\rvx=x\ar@/_1pc/[rr]|0
&m
&y
\\
x\ar[ru]
&\cald\rvm=m\ar[ru]
}
\begin{tabular}{l}
\\
by Rule 2
\end{tabular}
\\
$\color{red}=
\sum_{m}
P(y|\cald\rvm=m)
P(m|x)$
\\
\xymatrix{\\=\sum_m }
\xymatrix{
&m
&y
\\
x\ar[ru]
&\cald\rvm=m\ar[ru]
}
\begin{tabular}{l}
by Rule 3.\\
No info transmission\\
between $\cald\rvx$ and $\rvy$\\
if condition on $\cald \rvm$.
\end{tabular}
\\
$\color{red}=
\sum_{m,x'}
P(y|\cald\rvm=m, x')
P(x'|\cald\rvm=m)
P(m|x)$
\\
\xymatrix{\\=\sum_m}
\xymatrix{
&\sum x'\ar[dr]
\\
&m
&y
\\
x\ar[ru]
&\cald\rvm=m\ar[ru]\ar@/_2pc/[uu]|0
}
\\
$\color{red}=
\sum_{m,x'}
P(y|m, x')
P(x'|\cald\rvm=m)
P(m|x)$
\\
\xymatrix{\\=\sum_m}
\xymatrix{
&\sum x'\ar[dr]
&\cald\rvm=m\ar[l]|0
\\
&m\ar[r]
&y
\\
x\ar[ru]
}
\begin{tabular}{l}
\\
by Rule 2
\end{tabular}
\\
$\color{red}=
\sum_{m,x'}
P(y|m, x')
P(x')
P(m|x)$
\\
\xymatrix{\\=}
\xymatrix{
&\sum x'\ar[dr]
\\
x\ar[r]&\sum m\ar[r]
&y
}
\begin{tabular}{l}
\\
by Rule 3.
\\
No info transmission\\
between $\cald\rvm$ and $\rvx'$.
\end{tabular}
\end{longtable}



{\bf * proof 2:}
\begin{longtable}{l}
$\color{red}
P(y|\cald\rvx=x)=
\sum_m
P(y|\cald\rvx=x, m)
P(m|\cald\rvx=x)$
\\
\quad by Probability Axioms
\\
$\color{red}=
\sum_m
P(y|\cald\rvx=x, \cald\rvm=m)
P(m|\cald\rvx=x)$
\\
\quad $P(y|\cald\rvx=x, m)\rarrow
P(y|\cald\rvx=x, \cald m=m)$
\\
\quad by Rule 2:
\begin{tabular}{l}
\ruletwoif\\\ruletwothen
\end{tabular}
\\
\quad $\rvy\perp \rvm|\rvx$ in
$\call_\rvm\cald_\rvx G:$
$\xymatrix{
&*++[F-o]{\rvc}\ar[rd]
\\
\rvx\ar[r]
&\rvm
&\rvy
}$
\\
$\color{red}=
\sum_m
P(y|\cald\rvx=x, \cald\rvm=m)
P(m| x)$
\\
\quad $P(m|\cald\rvx=x)\rarrow P(m|x)$
\\
\quad by Rule 2:
\begin{tabular}{l}
\ruletwoif\\\ruletwothen
\end{tabular}
\\
\quad
$\rvm\perp \rvx$ in
$\call_\rvx\cald_\emptyset G:$
$\xymatrix{
&*++[F-o]{\rvc}\ar[ld]\ar[rd]
\\
\rvx
&\rvm\ar[r]
&\rvy
}$
\\
$\color{red}=
\sum_m
P(y|\cald\rvm=m)
P(m|x)$
\\
\quad $P(y|\cald\rvx=x, \cald\rvm=m)
\rarrow
 P(y|\cald\rvm=m)$
\\
\quad by Rule 3:
\begin{tabular}{l}
\rulethreeif\\\rulethreethen
\end{tabular}
\\
\quad
$\rvy\perp\rvx|\rvm$ in
$\cald_\rvx\cald_\rvm G:$
$\xymatrix{
&*++[F-o]{\rvc}\ar[rd]
\\
\rvx
&\rvm\ar[r]
&\rvy
}$
\\
$\color{red}=
\sum_{x'}
\sum_m
P(y|\cald\rvm=m, x')
P(x'|\cald\rvm=m)
P(m|x)$
\\
\quad by Probability Axioms
\\
$\color{red}=
\sum_{x'}
\sum_m
P(y|m, x')
P(x'|\cald\rvm=m)
P(m|x)$
\\
\quad $P(y|\cald\rvm=m, x')
\rarrow
\quad P(y|m, x')$
\\
\quad by Rule 2:
\begin{tabular}{l}
\ruletwoif\\\ruletwothen
\end{tabular}
\\
\quad
$\rvy\perp\rvm|\rvx$ in
$\call_\rvm \cald_\emptyset G:$
$\xymatrix{
&*++[F-o]{\rvc}\ar[rd]\ar[ld]
\\
\rvx\ar[r]
&\rvm
&\rvy
}$
\\
$\color{red}=
\sum_{x'}
\sum_m
P(y|m, x')
P(x')
P(m|x)$
\\
\quad $P(x'|\cald\rvm=m)
\rarrow
P(x')$
\\
\quad by Rule 3:
\begin{tabular}{l}
\rulethreeif\\\rulethreethen
\end{tabular}
\\
\quad
$\rvx\perp\rvm$ in
$\cald_\rvm \cald_\emptyset G:$
$\xymatrix{
&*++[F-o]{\rvc}\ar[rd]\ar[ld]
\\
\rvx
&\rvm\ar[r]
&\rvy
}$
\end{longtable}
\qed



\begin{claim}
\label{cl-decNapkin}
\decNapkin
\end{claim}
\proof
coming soon
\qed


\begin{claim}
\label{cl-decWhy}
\decWhy
\end{claim}
\proof
coming soon
\qed

\begin{claim}
\label{cl-decTransportTrivial}
\decTransportTrivial
\end{claim}
\proof
\begin{longtable}{l}
\color{red}
$P(y|\cald\rvx=x, z, \rvs=1)=
P(y|x, z, \rvs=1)$
\\
\xymatrix{
&z\ar[rd]
&\rvs=1\ar[d]
\\
\cald\rvx=x\ar[rr]
&&y
}
\xymatrix{
\\=
}
\xymatrix{
&z\ar[rd]
&\rvs=1\ar[d]
\\
x\ar[rr]
&&y
}
\end{longtable}
\qed

\begin{claim}
\label{cl-decTransportDirect}
\decTransportDirect
\end{claim}
\proof
\begin{longtable}{l}
\color{red}
$P(y|\cald\rvx=x, z, \rvs=1)=
P(y|\cald\rvx=x, z, \rvs=0)$
\\
\xymatrix{
\rvs=1\ar[r]
&z\ar[dr]
&
\\
\cald\rvx=x\ar[rr]
&&y
}
\xymatrix{\\=}
\xymatrix{
&z\ar[dr]
&
\\
\cald\rvx=x\ar[rr]
&&y
}
\end{longtable}
\qed

\begin{claim}
\label{cl-decTransportBox}
\decTransportBox
\end{claim}
\proof
\begin{longtable}{l}
\color{red}$
P(y|\cald\rvx=x, \rvs=1)
=
\sum_{a}
P(y|\cald\rvx=x, a, \rvs=1)P(a|\cald\rvx=x, \rvs=1)$
\\
\xymatrix{
\rvs=1\ar[drr]\ar[r]
&\sum z\ar[r]
&\sum a\ar[d]
\\
&\cald \rvx=x\ar[r]
&y
}\xymatrix{\\=}
\xymatrix{
\rvs=1\ar[r]\ar\ar@/_1pc/[rd]
&\sum a\ar[d]
\\
\cald \rvx=x\ar[r]\ar[ru]|0
&y
}
\\
\color{red}$
=\sum_{a}
P(y|\cald\rvx=x,a,  \rvs=1)P(a|\rvs=1)$
\\
\xymatrix{\\=}
\xymatrix{
\rvs=1\ar[r]\ar@/_1pc/[rd]
&\sum a\ar[d]
\\
\cald \rvx=x\ar[r]
&y
}
\\
\color{red}$
=\sum_{a}
P(y|\cald\rvx=x,a, \rvs=0)P(a|\rvs=1)$
\\
\xymatrix{\\=}
\xymatrix{
\rvs=1\ar[r]
&\sum a\ar[d]
\\
\cald \rvx=x\ar[r]
&y
}
\end{longtable}
\qed

\begin{claim}
\label{cl-decTransportOne}
 \decTransportOne
\end{claim}
\proof
\begin{longtable}{l}
\color{red}
$P(y|\cald \rvx=x, \rvs=1)=
\sum_ zP(y|\cald\rvx=x,z,
\rvs=1)P(z|\cald\rvx=x,\rvs=1)$
\\
\xymatrix{
\rvs=1\ar[r]
&\sum z\ar[dr]
\\
\cald\rvx=x\ar[rr]
&&y
}
\xymatrix{\\=}
\xymatrix{
\rvs=1\ar[r]\ar[rrd]|0
&\sum z\ar[rd]
\\
\cald\rvx=x\ar[rr]\ar[ru]|0
&&y
}
\\
\color{red}
$=\sum_ zP(y|\cald\rvx=x,z,
\rvs=1)P(z|\rvs=1)$
\\
\xymatrix{\\=}
\xymatrix{
\rvs=1\ar[r]\ar[rrd]|0
&\sum z\ar[rd]
\\
\cald\rvx=x\ar[rr]
&&y
}
\\
\color{red}
$=\sum_ zP(y|\cald\rvx=x,z,
\rvs=0)P(z|\rvs=1)$
\\
\xymatrix{\\=}
\xymatrix{
\rvs=1\ar[r]
&\sum z\ar[rd]
\\
\cald\rvx=x\ar[rr]
&&y
}
\end{longtable}
\qed

\begin{claim}
\label{cl-decTransportTwo}
\decTransportTwo
\end{claim}
\proof
\begin{longtable}{l}
\color{red}
$P(y|\cald \rvx=x, \rvs=1)=
\sum_ zP(y|\cald\rvx=x,z,
\rvs=1)P(z|\cald\rvx=x,\rvs=1)$
\\
\\
\xymatrix{
\rvs=1\ar@/^1.5pc/[rr]\ar[drr]|0
&*++[F-o]{\sum h}\ar[r]\ar[rd]
&\sum z
\\
\cald\rvx=x\ar[rr]
&&y
}
\xymatrix{\\=}
\xymatrix{
\rvs=1\ar@/^1.5pc/[rr]\ar[rrd]|0
&*++[F-o]{\sum h}\ar[r]\ar[rd]
&\sum z\ar[d]
\\
\cald\rvx=x\ar[rr]\ar@/_1pc/[rru]|0
&&y
}
\\
\color{red}
$=P(y|\cald\rvx=x,\rvs=1)$
\\
\xymatrix{\\=}
\xymatrix{
\rvs=1\ar[rrd]|0
\\
\cald\rvx=x\ar[rr]
&&y
}
\\
\color{red}
$=P(y|\cald\rvx=x,\rvs=0)$
\\
\xymatrix{=}
\xymatrix{
\cald\rvx=x\ar[rr]
&&y
}
\end{longtable}
\qed
\begin{claim}
\label{cl-decTransportThree}
\decTransportThree
\end{claim}
\proof

\begin{longtable}{l}
\color{red}
$P(y|\cald\rvx=x, \rvs=1)=
\sum_z P(y|\cald\rvx=x, z, \rvs=1)
P(z|\cald\rvx=x, \rvs=1)$
\\
\\
$\xymatrix{
\rvs=1\ar[rd]\ar[drr]|0
&*++[F-o]{\sum \rvh}\ar[dr]
\\
\cald\rvx=x\ar[r]
\ar@/_1.5pc/[rr]
&\sum z\ar[r]
&y
}
\xymatrix{\\=}
\xymatrix{
\rvs=1\ar[rd]\ar[drr]|0
\\
\cald\rvx=x\ar[r]
\ar@/_1.5pc/[rr]
&\sum z\ar[r]
&y
}$
\\
\\
\color{red}
$=\sum_z P(y|\cald\rvx=x, z, \rvs=0)
P(z|\cald\rvx=x, \rvs=1)$
\\
\\
$\xymatrix{\\=}\xymatrix{
\rvs=1\ar[rd]
\\
\cald\rvx=x\ar[r]
\ar@/_1.5pc/[rr]
&\sum z\ar[r]
&y
}$
\\
\\
\color{red}
$=\sum_z P(y|\cald\rvx=x, z, \rvs=0)
P(z|x, \rvs=1)$
\\
$\xymatrix{\\=}\xymatrix{
\rvs=1\ar[rd]
\\
x\ar[r]
&\sum z\ar[r]
&y
\\
\cald\rvx=x\ar[urr]
}$
\end{longtable}
\qed



%\input{do-calc-proofs/do-calc-proofs-limbo.tex}
